<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Performance | Login</title>
  <script>
    tailwind = { config: { corePlugins: { preflight: false } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0f1d;
      --card-bg: rgba(17, 28, 48, 0.8);
      --border: rgba(255, 255, 255, 0.06);
      --accent: #22d3ee;
      --accent-hover: #0ea5e9;
      --warm: #f59e0b;
      --text: #e2e8f0;
      --muted: #a5b4c5;
      --input-bg: rgba(11, 18, 32, 0.7);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background-color: var(--bg);
      background-image: 
        radial-gradient(circle at 15% 20%, rgba(34, 211, 238, 0.12), transparent 30%), 
        radial-gradient(circle at 80% 0%, rgba(245, 158, 11, 0.12), transparent 32%),
        radial-gradient(circle at 65% 60%, rgba(14, 165, 233, 0.1), transparent 28%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card {
      background: linear-gradient(160deg, rgba(17, 28, 48, 0.92), rgba(12, 20, 35, 0.92));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 24px;
      width: 100%;
      max-width: 420px;
      padding: 48px 40px;
      box-shadow: 0 25px 70px -12px rgba(0, 0, 0, 0.6);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    /* Animation for switching views */
    .fade-in { animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-container {
      margin-bottom: 24px;
      display: inline-flex;
      padding: 12px;
      background: rgba(34, 211, 238, 0.12);
      border-radius: 18px;
      border: 1px solid rgba(34, 211, 238, 0.25);
      box-shadow: 0 0 25px rgba(14, 165, 233, 0.25);
    }

    h1 { margin: 0 0 8px; font-size: 26px; font-weight: 700; letter-spacing: -0.03em; }
    p { margin: 0 0 32px; color: var(--muted); font-size: 14px; line-height: 1.5; }

    /* Clean Form Styles */
    form { display: flex; flex-direction: column; gap: 14px; width: 100%; }
    .form-group { margin: 0; text-align: left; }
    
    label { 
      display: block; 
      margin-bottom: 8px; 
      color: var(--muted); 
      font-size: 12px; 
      font-weight: 600; 
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-left: 4px;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 15px;
      outline: none;
      transition: all 0.2s ease;
      font-family: inherit;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    input::placeholder { color: rgba(148, 163, 184, 0.5); }
    input:focus {
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
      box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.2);
    }

    button.primary-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(120deg, var(--accent), #67e8f9);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }
    button.primary-btn:hover { 
      background: linear-gradient(120deg, #67e8f9, var(--accent)); 
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.35); 
    }

    /* Tabs for Signup */
    .tabs {
      display: flex;
      background: rgba(0,0,0,0.2);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: var(--card-bg); /* Match card or slightly lighter */
      background: rgba(255,255,255,0.1);
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* Toggle Link Area */
    .toggle-container { margin-top: 32px; font-size: 14px; color: var(--muted); }
    .toggle-container a { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 600; 
      transition: color 0.2s;
      margin-left: 4px;
    }
    .toggle-container a:hover { color: #818cf8; text-decoration: underline; }

    /* Utilities */
    .error { 
      color: #fca5a5; 
      background: rgba(127, 29, 29, 0.25); 
      border: 1px solid rgba(248, 113, 113, 0.2); 
      padding: 12px; 
      border-radius: 10px; 
      margin-bottom: 24px; 
      font-size: 13px;
      text-align: center;
      display: none;
    }
    .info-badge {
      display: inline-block;
      font-size: 11px;
      background: rgba(245, 158, 11, 0.15);
      padding: 4px 8px;
      border-radius: 6px;
      color: #fef3c7;
      margin-top: 8px;
      border: 1px solid rgba(245, 158, 11, 0.25);
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo-container">
      <svg width="40" height="40" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 1L28.99 8.5V23.5L16 31L3.01 23.5V8.5L16 1Z" fill="rgba(99, 102, 241, 0.2)" stroke="#6366f1" stroke-width="2" stroke-linejoin="round"/>
        <path d="M8 16H12L15 11L19 21L22 16H26" stroke="#f8fafc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <div id="error" class="error"></div>

    <div id="view-login" class="fade-in">
      <h1>Welcome Back</h1>
      <p>Enter your credentials to access the portal.</p>
      
      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input id="username" name="username" placeholder="e.g. johndoe" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" placeholder="••••••••" required />
        </div>
        <button type="submit" class="primary-btn">Sign In</button>
      </form>

      <div class="toggle-container">
        New here? <a href="#" onclick="switchView('signup')">Create an account</a>
      </div>
    </div>

    <div id="view-signup" class="fade-in hidden">
      <h1>Create Account</h1>
      <p style="margin-bottom: 20px;">Select your account type below.</p>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('parent')" id="tab-parent">Parent</button>
        <button class="tab-btn" onclick="switchTab('teacher')" id="tab-teacher">Teacher</button>
      </div>

      <form id="signup-parent-form">
        <div class="form-group">
          <label>Full Name</label>
          <input id="su-fullname" placeholder="John Doe" required />
        </div>
        <div class="form-group">
          <label>Username</label>
          <input id="su-username" placeholder="Choose a username" required />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="su-password" type="password" placeholder="Create a password" required />
        </div>
        <div class="form-group">
          <label>Child's Student Number</label>
          <input id="su-studentnum" placeholder="Last 5 digits (e.g. 01234)" maxlength="5" pattern="\d{5}" inputmode="numeric" required />
        </div>
        <button type="submit" class="primary-btn">Create Parent Account</button>
      </form>

      <form id="signup-teacher-form" class="hidden">
        <div class="form-group">
          <label>Full Name</label>
          <input id="ts-fullname" placeholder="Jane Smith" required />
        </div>
        <div class="form-group">
          <label>Username</label>
          <input id="ts-username" placeholder="Choose a username" required />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="ts-password" type="password" placeholder="Create a password" required />
        </div>
        <div class="info-badge">ℹ️ Teacher accounts require admin approval</div>
        <button type="submit" class="primary-btn">Request Teacher Access</button>
      </form>

      <div class="toggle-container">
        Already have an account? <a href="#" onclick="switchView('login')">Sign in</a>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin + "/api";
    const errorBox = document.getElementById("error");

    // View Switching Logic
    function switchView(viewName) {
      errorBox.style.display = 'none';
      errorBox.textContent = '';
      
      const loginView = document.getElementById("view-login");
      const signupView = document.getElementById("view-signup");

      if (viewName === 'signup') {
        loginView.classList.add("hidden");
        signupView.classList.remove("hidden");
      } else {
        signupView.classList.add("hidden");
        loginView.classList.remove("hidden");
      }
    }

    // Tab Switching Logic (Parent vs Teacher)
    function switchTab(type) {
      errorBox.style.display = 'none';
      
      const parentForm = document.getElementById("signup-parent-form");
      const teacherForm = document.getElementById("signup-teacher-form");
      const tabParent = document.getElementById("tab-parent");
      const tabTeacher = document.getElementById("tab-teacher");

      if (type === 'parent') {
        parentForm.classList.remove("hidden");
        teacherForm.classList.add("hidden");
        tabParent.classList.add("active");
        tabTeacher.classList.remove("active");
      } else {
        parentForm.classList.add("hidden");
        teacherForm.classList.remove("hidden");
        tabParent.classList.remove("active");
        tabTeacher.classList.add("active");
      }
    }

    // --- FORM HANDLERS ---

    // Login
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      errorBox.style.display = "none";
      const payload = {
        username: document.getElementById("username").value.trim(),
        password: document.getElementById("password").value.trim(),
      };
      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Login failed");
        localStorage.setItem("spms_user", JSON.stringify(data));
        window.location.href = "dashboard.html";
      } catch (err) {
        showError(err.message);
      }
    });

    // Parent Signup
    document.getElementById("signup-parent-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      errorBox.style.display = "none";
      const raw = document.getElementById("su-studentnum").value.trim();
      if (!/^\d{5}$/.test(raw)) {
        showError("Student number must be exactly the last 5 digits.");
        return;
      }
      const payload = {
        username: document.getElementById("su-username").value.trim(),
        password: document.getElementById("su-password").value.trim(),
        full_name: document.getElementById("su-fullname").value.trim(),
        student_number: `STU-${raw}`,
      };
      try {
        const res = await fetch(`${API_BASE}/signup/parent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Signup failed");
        // Auto-login
        localStorage.setItem("spms_user", JSON.stringify({
          id: data.id,
          username: payload.username,
          role: "Parent",
          full_name: payload.full_name,
        }));
        window.location.href = "dashboard.html";
      } catch (err) {
        showError(err.message);
      }
    });

    // Teacher Signup
    document.getElementById("signup-teacher-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      errorBox.style.display = "none";
      const payload = {
        username: document.getElementById("ts-username").value.trim(),
        password: document.getElementById("ts-password").value.trim(),
        full_name: document.getElementById("ts-fullname").value.trim(),
      };
      try {
        const res = await fetch(`${API_BASE}/signup/teacher`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || "Signup failed");
        }
        showSuccess("Request submitted! Please wait for admin approval.");
        document.getElementById("signup-teacher-form").reset();
      } catch (err) {
        showError(err.message);
      }
    });

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      errorBox.style.background = "rgba(127, 29, 29, 0.25)";
      errorBox.style.borderColor = "rgba(248, 113, 113, 0.2)";
      errorBox.style.color = "#fca5a5";
    }

    function showSuccess(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      errorBox.style.background = "rgba(16, 185, 129, 0.2)";
      errorBox.style.borderColor = "rgba(16, 185, 129, 0.3)";
      errorBox.style.color = "#6ee7b7";
    }
  </script>
</body>
</html>