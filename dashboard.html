<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Performance | Dashboard</title>
  <script>
    tailwind = { config: { corePlugins: { preflight: false } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #05070f;
      --bg-elevated: linear-gradient(145deg, #05070f 0%, #060915 100%);
      --sidebar: #0a0f1d;
      --card: #0e1322;
      --card-strong: #121a2c;
      --surface: rgba(255,255,255,0.02);
      --border: rgba(255, 255, 255, 0.08);
      --border-strong: rgba(255, 255, 255, 0.16);
      --accent: #7c3aed;
      --accent-2: #22d3ee;
      --accent-3: #3b82f6;
      --accent-hover: #6f46ff;
      --accent-soft: rgba(124, 58, 237, 0.12);
      --muted: #9aa7c4;
      --muted-strong: #e6e9f5;
      --text: #eef2ff;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 14px 28px rgba(0,0,0,0.28);
      --shadow-soft: 0 8px 18px rgba(0,0,0,0.22);
      --radius: 14px;
    }
    * { box-sizing: border-box; outline: none; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

    html { scroll-behavior: auto; }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg-elevated);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      letter-spacing: 0.01em;
      backdrop-filter: blur(2px);
    }

    /* Sidebar Styling */
    aside {
      background: var(--sidebar);
      border-right: 1px solid var(--border-strong);
      padding: 26px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      flex-shrink: 0;
      z-index: 12;
      box-shadow: var(--shadow);
    }
    .brand { 
      font-size: 18px; 
      font-weight: 800; 
      letter-spacing: -0.025em; 
      color: white; 
      margin-bottom: 18px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .brand::before {
      content: '';
      display: block;
      width: 10px;
      height: 10px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 12px var(--accent);
    }
    nav { display: flex; flex-direction: column; gap: 6px; flex: 1; overflow: hidden; }
    nav button {
      width: 100%;
      color: var(--muted);
      background: transparent;
      border: 1px solid transparent;
      text-align: left;
      padding: 11px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0;
      transition: all 0.18s ease;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      isolation: isolate;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }
    .nav-icon {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: inherit;
      opacity: 0.9;
    }
    nav button::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border-strong);
      display: inline-flex;
      flex-shrink: 0;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    nav button:hover {
      background: var(--surface);
      border-color: var(--border);
      color: var(--muted-strong);
    }
    nav button:hover::before { background: var(--accent-2); transform: scale(1.05); }
    nav button.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      border-color: transparent;
      box-shadow: 0 16px 34px rgba(128, 91, 255, 0.28);
    }
    nav button.active::before { background: white; }
    nav button[onclick="logout()"] {
      margin-top: auto;
      color: #f87171;
    }

    main {
      flex: 1;
      padding: 32px 36px 44px;
      max-width: 1500px;
      margin: 0 auto;
      width: 100%;
      overflow-x: hidden;
    }
    nav button[onclick="logout()"]:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
    }
    
    header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 28px; 
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 18px;
      box-shadow: var(--shadow-soft);
    }
    header h2 {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #user-name {
      font-size: 22px;
      margin-top: 4px;
      color: white;
      font-weight: 600;
    }

    /* Cards */
    .cards { display: grid; gap: 18px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 28px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: border-color 0.2s, transform 0.15s ease, box-shadow 0.2s;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }
    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at 15% 15%, rgba(128,91,255,0.07), transparent 45%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .card:hover {
      border-color: var(--border-strong);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .card:hover::after { opacity: 1; }
    .card h3 { 
      margin: 0 0 10px; 
      font-size: 12px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      color: var(--muted); 
      font-weight: 600;
    }
    .card .value { font-size: 28px; font-weight: 700; color: white; letter-spacing: -0.02em; }

    /* Accordions / stacks */
    .stacked { display: flex; flex-direction: column; gap: 16px; }
    details.accordion {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(6px);
    }
    details.accordion[open] { border-color: rgba(255,255,255,0.14); }
    details.accordion summary {
      list-style: none;
      cursor: pointer;
      padding: 14px 16px;
      margin: 0;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }
    details.accordion summary::after {
      content: "â€º";
      font-size: 18px;
      color: var(--muted);
      transition: transform 0.2s ease;
    }
    details.accordion[open] summary::after { transform: rotate(90deg); color: var(--muted-strong); }
    details.accordion summary::-webkit-details-marker { display: none; }
    .accordion-body { padding: 16px; border-top: 1px solid var(--border); background: rgba(255,255,255,0.01); }

    /* Grid Layouts */
    .grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); margin-bottom: 28px; }
    
    /* Charts */
    canvas { 
      background: rgba(10, 15, 26, 0.5); 
      border-radius: 10px; 
      padding: 12px; 
      width: 100% !important;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-top: 12px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      background: transparent;
      min-width: 500px;
    }
    th, td { 
      padding: 14px 16px; 
      text-align: left; 
      font-size: 13px; 
      border-bottom: 1px solid var(--border); 
    }
    th { 
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.15)); 
      font-weight: 700; 
      color: var(--muted); 
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      backdrop-filter: blur(4px);
    }
    tr:last-child td { border-bottom: none; }
    tbody tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
    tbody tr:hover td { background: rgba(255,255,255,0.04); }
    
    /* Forms */
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 16px;
      background: rgba(255, 255, 255, 0.02);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }
    
    input, select, textarea {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.025);
      color: white;
      font-size: 13px;
      font-family: inherit;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      width: 100%;
      box-shadow: none;
    }
    input::placeholder,
    textarea::placeholder {
      color: var(--muted);
      opacity: 0.9;
      letter-spacing: 0.01em;
    }
    select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 16px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 32px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.18);
      background: rgba(255,255,255,0.05);
    }
    textarea { min-height: 80px; resize: vertical; }
    
    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      border: 1px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      padding: 11px 18px;
      font-size: 13px;
      transition: transform 0.12s ease, box-shadow 0.18s ease, filter 0.18s ease;
      font-family: inherit;
      box-shadow: 0 14px 32px rgba(128, 91, 255, 0.25);
    }
    button:hover { filter: brightness(1.03); box-shadow: 0 16px 34px rgba(128,91,255,0.28); }
    button:active { transform: translateY(1px); }
    button:focus-visible { outline: 2px solid var(--muted-strong); outline-offset: 2px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    button.btn-secondary {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      color: var(--muted-strong);
      box-shadow: none;
    }
    button.btn-secondary:hover {
      background: var(--surface);
      color: white;
      border-color: var(--border-strong);
    }
    button.btn-text {
      background: transparent;
      border: none;
      color: var(--accent);
      font-weight: 700;
      box-shadow: none;
      padding: 8px 10px;
    }
    button.btn-text:hover { color: white; text-decoration: underline; }
    
    /* Specific Button Styles */
    .delete-student, .section-delete {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
      padding: 6px 12px !important;
      font-size: 12px !important;
    }
    .delete-student:hover, .section-delete:hover {
      background: rgba(239, 68, 68, 0.2) !important;
    }
    
    .print-report, .edit-subject {
      background: rgba(99, 102, 241, 0.1) !important;
      color: #a5b4fc !important;
      border: 1px solid rgba(99, 102, 241, 0.2) !important;
      padding: 6px 12px !important;
      font-size: 12px !important;
    }
    .print-report:hover, .edit-subject:hover {
      background: rgba(99, 102, 241, 0.2) !important;
    }

    #trend-refresh {
        width: auto;
        padding: 10px 20px;
    }

    /* Utilities */
    .error { 
      color: #fecdd3; 
      background: rgba(127, 29, 29, 0.25);
      padding: 12px 14px;
      border-radius: 10px;
      margin: 10px 0; 
      font-size: 13px; 
      font-weight: 600;
      border: 1px solid rgba(239, 68, 68, 0.28);
      display: none;
      box-shadow: var(--shadow-soft);
    }
    .select-search {
      min-width: 160px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.025);
      color: white;
      font-size: 13px;
      font-family: inherit;
    }
    .select-search::placeholder { color: var(--muted); }
    .tab { display: none; animation: fadeIn 0.2s ease; padding: 4px 0 12px; }
    .tab.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .section-title { margin: 24px 0 12px; color: white; font-size: 16px; font-weight: 600; }
    .section-title:first-child { margin-top: 0; }
    .flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    
    .pill-input { border-radius: 20px; }

    /* Badges / pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--muted-strong);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .pill.accent { background: var(--accent-soft); color: white; border-color: transparent; }
    .pill.success { background: rgba(16, 185, 129, 0.12); color: #bbf7d0; border-color: rgba(16,185,129,0.3); }
    .suggestions {
      margin-top: 6px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      max-height: 180px;
      overflow: auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    .suggestions div {
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .suggestions div:last-child { border-bottom: none; }
    .suggestions div:hover { background: rgba(99, 102, 241, 0.1); color: var(--accent); }

     .badge {
       display: inline-block;
       min-width: 18px;
       padding: 2px 6px;
       border-radius: 999px;
       background: #f97316;
       color: white;
       font-size: 10px;
       font-weight: 700;
       vertical-align: middle;
       margin-left: 6px;
     }

    /* Responsive */
    @media (max-width: 900px) {
      body { grid-template-columns: 1fr; }
      aside { 
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 260px;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      aside.open { transform: translateX(0); }
      
      .mobile-header {
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        background: var(--sidebar);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 40;
      }
      
      .brand { margin-bottom: 20px; }
      nav button { font-size: 13px; }
      nav button[onclick="logout()"] { margin-top: auto; }
      main { padding: 16px; }
      .grid { grid-template-columns: 1fr; }
      
      #sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        z-index: 45;
        display: none;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }
      #sidebar-overlay.active { display: block; }
    }

    /* Toast Notifications */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 14px 18px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      color: white;
      font-size: 13px;
      min-width: 280px;
      animation: slideIn 0.3s ease forwards;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--danger); }
    .toast.info { border-left: 3px solid var(--accent); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* Background paths (login aesthetic, non-React port) */
    .bg-paths-host {
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    .bg-paths {
      position: absolute;
      inset: 0;
      pointer-events: none;
      color: #0f172a;
      opacity: 0.7;
      mix-blend-mode: screen;
    }
    .bg-paths svg {
      width: 100%;
      height: 100%;
    }
    @media (prefers-color-scheme: dark) {
      .bg-paths { color: #ffffff; opacity: 0.65; }
    }
    @keyframes bg-path-flow {
      0%   { stroke-dasharray: 0, 1200; stroke-dashoffset: 1200; opacity: 0.35; }
      25%  { stroke-dasharray: 1200, 1200; stroke-dashoffset: 900; opacity: 0.55; }
      50%  { stroke-dashoffset: 600; opacity: 0.42; }
      75%  { stroke-dashoffset: 300; opacity: 0.6; }
      100% { stroke-dasharray: 0, 1200; stroke-dashoffset: 1200; opacity: 0.35; }
    }

    /* Loading Overlay */
    #loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 15, 26, 0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #loading-overlay.active { opacity: 1; pointer-events: all; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--accent);
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>
  <div id="toast-container"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="mobile-header" style="display:none;">
    <div class="brand" style="margin:0; font-size:16px;">
      <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 1L28.99 8.5V23.5L16 31L3.01 23.5V8.5L16 1Z" fill="rgba(99, 102, 241, 0.2)" stroke="#6366f1" stroke-width="2" stroke-linejoin="round"/>
        <path d="M8 16H12L15 11L19 21L22 16H26" stroke="#f8fafc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>SPMS</span>
    </div>
    <button onclick="toggleSidebar()" style="padding:8px; background:transparent;" aria-label="Toggle navigation" title="Toggle navigation">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </div>

  <aside id="sidebar">
    <div class="brand" style="display:flex; align-items:center; gap:12px;">
      <svg width="40" height="40" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 1L28.99 8.5V23.5L16 31L3.01 23.5V8.5L16 1Z" 
              fill="rgba(99, 102, 241, 0.2)" 
              stroke="#6366f1" 
              stroke-width="2" 
              stroke-linejoin="round"/>
        <path d="M8 16H12L15 11L19 21L22 16H26" 
              stroke="#f8fafc" 
              stroke-width="2" 
              stroke-linecap="round" 
              stroke-linejoin="round"/>
      </svg>
      <span>SPMS Dashboard</span>
    </div>
    <nav>
      <button class="active" data-tab="overview">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 13h5v7H4z"/><path d="M15 4h5v16h-5z"/><path d="M9 9h5v11H9z"/></svg>
        </span>
        Overview
      </button>
      <button data-tab="students">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0 1 13 0"/></svg>
        </span>
        Students
      </button>
      <button data-tab="sections">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="6" rx="1"/><rect x="3" y="14" width="10" height="6" rx="1"/><path d="M17 14h4v6h-4z"/></svg>
        </span>
        Sections
      </button>
      <button data-tab="logs">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19h16"/><path d="M9 15h1"/><path d="M9 11h1"/><path d="M9 7h1"/><path d="M14 15h1"/><path d="M14 11h1"/><path d="M14 7h1"/><rect x="5" y="4" width="14" height="16" rx="2"/></svg>
        </span>
        Grades
      </button>
      <button data-tab="grade-sheet">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h9l5 5v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path d="M14 4v5h5"/><path d="M8 13h8"/><path d="M8 17h5"/></svg>
        </span>
        Grade Sheet
      </button>
      <button data-tab="attendance">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
        </span>
        Attendance
      </button>
      <button data-tab="trends">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 7-7"/><path d="M14 7h7v7"/></svg>
        </span>
        Trends
      </button>
      <button data-tab="comms">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 7.5 7.5z"/></svg>
        </span>
        Communications <span id="comms-badge" class="badge" style="display:none;">0</span>
      </button>
      <button data-tab="subjects">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15a1 1 0 0 1 1.5-.86l13 7.5a1 1 0 0 1 0 1.72l-13 7.5A1 1 0 0 1 4 19.5z"/></svg>
        </span>
        Subjects
      </button>
      <button data-tab="admin">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 10.91 3V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </span>
        Administration <span id="admin-pending-badge" class="badge" style="display:none;">0</span>
      </button>
      <button onclick="logout()">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </span>
        Logout
      </button>
    </nav>
  </aside>
  <main>
    <header>
      <div>
        <div style="color: var(--muted); font-size: 13px; font-weight: 500;">Welcome back</div>
        <div id="user-name" style="font-weight: 700;">Loading...</div>
      </div>
    </header>

    <section class="tab active" id="tab-overview">
      <div class="cards">
        <div class="card"><h3>Students</h3><div class="value" id="total-students">-</div></div>
        <div class="card"><h3>Grades Recorded</h3><div class="value" id="total-grades">-</div></div>
        <div class="card"><h3>Behavior Reports</h3><div class="value" id="total-behaviors">-</div></div>
        <div class="card"><h3>Communications</h3><div class="value" id="total-comms">-</div></div>
      </div>
      <div class="grid">
        <div class="card">
          <h3 style="margin-bottom: 20px;">Attendance Rates</h3>
          <canvas id="attendanceChart" height="240"></canvas>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 20px;">Average Grades per Subject</h3>
          <canvas id="gradesChart" height="240"></canvas>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-students">
      <h3 class="section-title" style="margin-top:0;">Manage Students</h3>
      <div id="student-error" class="error"></div>
      <form id="student-form">
        <input id="student-number" placeholder="Last 5 digits (e.g., 01234)" maxlength="5" pattern="[0-9]{5}" inputmode="numeric" title="Enter exactly 5 digits" required />
        <input id="student-first" placeholder="First name" required />
        <input id="student-middle" placeholder="Middle initial" maxlength="1" />
        <input id="student-last" placeholder="Last name" required />
        <input id="student-dob" type="date" />
        <input id="student-grade" placeholder="Grade level" />
        <select id="student-section">
          <option value="">Section (optional)</option>
        </select>
        <button type="submit">Add Student</button>
      </form>
      <p class="section-title">Directory</p>
      <div class="table-container">
        <table id="students-table">
          <thead><tr><th>Student #</th><th>Name</th><th>Grade</th><th>Homeroom</th><th>Birthdate (DOB)</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
      </div>
      <div id="admin-students-panel" class="card" style="margin-top:16px; display:none;">
        <h3>Students (Admin)</h3>
        <input id="admin-student-search" class="pill-input" placeholder="Search student name or number..." style="margin-bottom:10px;">
        <div class="table-container" style="max-height:260px;">
          <table id="admin-students-table">
            <thead><tr><th>#</th><th>Name</th><th>Grade</th><th>Section</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-sections">
      <h3 class="section-title" style="margin-top:0;">Manage Sections / Classes</h3>
      <div id="section-error" class="error"></div>
      <div class="stacked">
        <details class="accordion" open>
          <summary>Create / Update Section</summary>
          <div class="accordion-body">
            <form id="section-form" style="grid-template-columns: repeat(auto-fit, minmax(180px,1fr));">
              <input id="section-name" placeholder="Section name (e.g., Grade 7 - A)" required />
              <select id="section-band">
                <option value="">Band (optional)</option>
                <option value="JHS">JHS</option>
                <option value="SHS">SHS</option>
              </select>
              <input id="section-grade" placeholder="Grade level (e.g., 7)" />
              <input id="section-track" placeholder="Track/Strand (optional)" />
              <select id="section-adviser">
                <option value="">Adviser (optional)</option>
              </select>
              <button type="submit">Save Section</button>
            </form>
            <p style="font-size:12px; color: var(--muted); margin-top:8px;">Admins only: create/edit/delete sections and assign students.</p>
          </div>
        </details>

        <details class="accordion" open>
          <summary>Assign Students to Section</summary>
          <div class="accordion-body">
            <div style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px;">
              <input class="select-search" id="assign-section-search" placeholder="Search section..." oninput="filterSelect('assign-section', this.value)">
              <select id="assign-section" style="min-width:200px;"></select>
              <input class="select-search" id="assign-student-search" placeholder="Search student..." oninput="filterSelect('assign-student', this.value)">
              <select id="assign-student" style="min-width:200px;"></select>
              <button id="assign-btn" type="button">Assign</button>
            </div>
            <div id="section-roster" class="table-container" style="max-height:260px;">
              <table>
                <thead><tr><th>Student</th><th>Grade</th></tr></thead>
                <tbody id="section-roster-body"></tbody>
              </table>
            </div>
          </div>
        </details>

        <details class="accordion">
          <summary>Rooms</summary>
          <div class="accordion-body">
            <form id="room-form" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px; margin-bottom:12px;">
              <input id="room-name" placeholder="Room name (e.g., Room 101)" required />
              <input id="room-building" placeholder="Building (optional)" />
              <input id="room-level" placeholder="Level/Floor (optional)" />
              <button type="submit">Add Room</button>
            </form>
            <div class="table-container" style="max-height:200px;">
              <table>
                <thead><tr><th>Name</th><th>Building</th><th>Level</th><th></th></tr></thead>
                <tbody id="room-table-body"></tbody>
              </table>
            </div>
            <div id="room-status" style="font-size:12px; color: var(--muted); margin-top:6px;"></div>
          </div>
        </details>

        <details class="accordion" open>
          <summary>Section Schedule</summary>
          <div class="accordion-body">
            <div style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px;">
              <input class="select-search" id="schedule-section-search" placeholder="Search section..." oninput="filterSelect('schedule-section', this.value)">
              <select id="schedule-section" style="min-width:200px;"></select>
              <label style="display:flex; align-items:center; gap:6px; font-size:12px; color: var(--muted);">
                <input id="schedule-allow-sat" type="checkbox" /> Allow Saturday (make-up)
              </label>
              <button id="schedule-generate" type="button">Generate Schedule</button>
              <button id="schedule-print" type="button" class="btn-secondary">Print</button>
              <button id="schedule-pdf" type="button" class="btn-secondary">Download PDF</button>
            </div>
            <div class="table-container" style="max-height:260px;">
              <table id="section-schedule-table">
                <thead><tr><th>Day</th><th>Time</th><th>Subject</th><th>Teacher</th><th>Room</th></tr></thead>
                <tbody id="section-schedule-body"></tbody>
              </table>
            </div>
            <div id="schedule-status" style="font-size:12px; color: var(--muted); margin-top:8px;"></div>
          </div>
        </details>
      </div>

      <details class="accordion" open>
        <summary>Sections Directory</summary>
        <div class="accordion-body">
          <div class="table-container">
            <table id="sections-table">
              <thead><tr><th>Name</th><th>Band</th><th>Grade</th><th>Track</th><th>Adviser</th><th>Students</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </details>
    </section>

    <section class="tab" id="tab-logs">
      <div class="grid">
        <div class="card">
          <h3>Final Grades</h3>
          <div id="grade-error" class="error"></div>
          <div style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px;">
            <input class="select-search" id="grade-section-search" placeholder="Search section..." oninput="filterSelect('grade-section', this.value)">
            <select id="grade-section" style="min-width:160px;">
              <option value="">All sections</option>
            </select>
            <input class="select-search" id="grade-student-search" placeholder="Search student..." oninput="filterSelect('grade-student', this.value)">
            <select id="grade-student" style="min-width:180px;"></select>
            <input class="select-search" id="grade-subject-search" placeholder="Search subject..." oninput="filterSelect('grade-subject', this.value)">
            <select id="grade-subject" style="min-width:200px;">
              <option value="">All subjects</option>
            </select>
            <button id="grade-refresh" type="button" class="btn-secondary">Refresh</button>
            </div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
            <button id="grade-report-btn" type="button">Download Report Card (selected student)</button>
            </div>
          <div id="grade-status" style="font-size:12px; color: var(--muted); margin-bottom:8px;"></div>
          <div class="table-container">
            <table id="grades-table">
              <thead><tr><th>Student</th><th>Subject</th><th>WW Avg</th><th>PT Avg</th><th>QA Avg</th><th>Final %</th><th>Entries</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
        </div>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-attendance">
      <div class="grid">
        <div class="card">
          <h3>Attendance Sheet (Today)</h3>
          <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:8px; font-size:13px; color: var(--muted);">
            <span id="attendance-clock" style="font-weight:600; color:#e0e7ff;">--:--</span>
            <span id="next-class-label" style="display:none;">Next class: <span id="next-class-value"></span></span>
          </div>
          <div id="attendance-error" class="error"></div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:12px;">
            <select id="attendance-section">
              <option value="">All sections</option>
            </select>
            <select id="attendance-subject">
              <option value="">All subjects</option>
            </select>
            <input id="attendance-date" type="date" required readonly />
            <button id="attendance-save" type="button" style="background: var(--accent); border:none;">Save Sheet</button>
          </div>
          <div class="table-container" style="max-height: 360px;">
            <table id="attendance-sheet-table">
              <thead><tr><th>Student</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <p style="font-size:12px; color: var(--muted); margin-top:8px;">Status defaults to Present for quick entry. Saving will record the whole sheet for the selected date.</p>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h3>Today's Attendance</h3>
          <div class="table-container">
            <table id="attendance-today-table">
              <thead><tr><th>Student</th><th>Date</th><th>Status</th><th>Update</th></tr></thead>
            <tbody></tbody>
          </table>
          </div>
        </div>
        <div class="card">
          <h3>Attendance History (Editable)</h3>
          <div class="table-container">
            <table id="attendance-history-table">
              <thead><tr><th>Student</th><th>Date</th><th>Status</th><th>Update</th></tr></thead>
            <tbody></tbody>
          </table>
          </div>
        </div>
        <div class="card" id="teacher-schedule-card" style="display:none;">
          <h3>My Schedule (This Week)</h3>
          <div class="table-container" style="max-height:260px;">
            <table>
              <thead><tr><th>Day</th><th>Time</th><th>Section</th><th>Subject</th><th>Room</th></tr></thead>
              <tbody id="teacher-schedule-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-trends">
      <div class="card">
          <div class="flex" style="margin-bottom: 20px;">
            <input class="select-search" id="trend-student-search" placeholder="Search student..." oninput="filterSelect('trend-student', this.value)" style="max-width: 240px;">
            <select id="trend-student" style="max-width: 300px;"></select>
            <button id="trend-refresh" class="btn-secondary">Refresh Trends</button>
          </div>
          <h3>Grade Trend (by assessment date)</h3>
          <canvas id="trendChart" height="120" style="max-height: 400px;"></canvas>
      </div>
    </section>

    <section class="tab" id="tab-grade-sheet">
      <h3 class="section-title" style="margin-top:0;">Grade Sheet (Class Record)</h3>
      <div class="card">
        <div id="sheet-error" class="error"></div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:12px;">
          <select id="sheet-band" style="display:none;">
            <option value="">All (Admin)</option>
            <option value="JHS">JHS</option>
            <option value="SHS">SHS</option>
          </select>
          <input class="select-search" id="sheet-subject-search" placeholder="Search subject..." oninput="filterSelect('sheet-subject', this.value)">
          <select id="sheet-subject">
            <option value="">Select subject</option>
          </select>
          <input class="select-search" id="sheet-section-search" placeholder="Search section..." oninput="filterSelect('sheet-section', this.value)">
          <select id="sheet-section">
            <option value="">All sections</option>
          </select>
          <button id="sheet-add-activity" type="button" class="btn-secondary">Add Column</button>
          <button id="sheet-save" type="button" style="background: var(--accent); border:none;">Save Sheet</button>
        </div>
        <div id="sheet-weights" style="font-size:12px; color: var(--muted); margin-bottom: 8px;">Weights: -</div>
        <div class="table-container" style="max-height: 420px;">
          <table id="sheet-table">
            <thead><tr id="sheet-header-row"><th>Student</th><th>Final</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="sheet-status" style="font-size:12px; color: var(--muted); margin-top:8px;"></div>
      </div>
    </section>

    <section class="tab" id="tab-comms">
      <h3 class="section-title" style="margin-top:0;">Parent-Teacher Communication</h3>
       <div id="comms-alert" class="error" style="display:none; background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); color: #bbf7d0;">
         New messages received. Open Communications to view.
       </div>
      <div id="comm-error" class="error"></div>
      <form id="comm-form">
        <div class="flex" style="flex-wrap: wrap; gap:16px; grid-column: span 2;">
          <div style="flex:1; min-width:200px;">
            <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Student Reference</label>
            <input id="comm-student-search" class="pill-input" placeholder="Search student name..." autocomplete="off" />
            <div id="comm-student-suggestions" class="suggestions"></div>
            <input type="hidden" id="comm-student-id" />
          </div>
          <div style="flex:1; min-width:200px;">
            <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Recipient</label>
            <input id="comm-teacher-search" class="pill-input" placeholder="Search teacher..." autocomplete="off" />
            <div id="comm-teacher-suggestions" class="suggestions"></div>
            <input type="hidden" id="comm-teacher-name" />
          </div>
        </div>
        
        <input id="comm-sender" placeholder="Your name" readonly style="background: rgba(255,255,255,0.02); color: var(--muted);" />
        <input id="comm-subject" placeholder="Subject" required />
        <textarea id="comm-body" placeholder="Type your message here..." required style="grid-column: 1 / -1;"></textarea>
        <button type="submit" style="grid-column: 1 / -1;">Send / Log Message</button>
      </form>
      <p class="section-title">Message History</p>
      <div class="table-container">
      <table id="comm-table">
        <thead><tr><th>Subject</th><th>From</th><th>To</th><th>Student</th><th>Date</th></tr></thead>
        <tbody></tbody>
      </table>
      </div>
    </section>

    <section class="tab" id="tab-subjects">
      <h3 class="section-title" style="margin-top:0;">Subject Management</h3>
      <div class="card">
        <div id="subject-error" class="error"></div>
        <form id="subject-form" style="background: transparent; border: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
          <input id="sub-id" type="hidden" />
          <input id="sub-name" placeholder="Subject name" required />
          <select id="sub-level" required>
            <option value="">Level band</option>
            <option value="JHS">JHS (7-10)</option>
            <option value="SHS">SHS (11-12)</option>
          </select>
          <select id="sub-category" required>
            <option value="">Category</option>
            <option>Core</option>
            <option>Applied</option>
            <option>Specialized</option>
            <option>Institutional</option>
          </select>
          <select id="sub-track">
            <option value="">Track / Strand (optional)</option>
            <option>STEM</option>
            <option>ABM</option>
            <option>HUMSS</option>
            <option>ICT</option>
            <option>GAS</option>
            <option>Institutional</option>
          </select>
          <input id="sub-grade-min" type="number" min="7" max="12" placeholder="Grade from" />
          <input id="sub-grade-max" type="number" min="7" max="12" placeholder="Grade to" />
          <select id="sub-teacher">
            <option value="">Assign teacher (optional)</option>
          </select>
          <div style="display:flex; gap:8px; grid-column: 1 / -1; flex-wrap: wrap;">
            <button id="sub-submit" type="submit">Add Subject</button>
            <button id="sub-cancel" type="button" style="background: rgba(255,255,255,0.08); display:none;">Cancel Edit</button>
          </div>
        </form>
        <div style="max-height: 320px; overflow-y: auto; margin-top: 12px;">
          <div class="table-container">
            <table id="subjects-table">
              <thead><tr><th>Name</th><th>Level</th><th>Cat.</th><th>Track</th><th>Teacher</th><th>Grades</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-admin">
      <h3 class="section-title" style="margin-top:0;">Adviser Dashboard</h3>
      <div class="cards">
        <div class="card"><h3>Total Students</h3><div class="value" id="admin-total-students">-</div></div>
        <div class="card"><h3>Total Grades</h3><div class="value" id="admin-total-grades">-</div></div>
        <div class="card"><h3>Attendance Logs</h3><div class="value" id="admin-total-att">-</div></div>
        <div class="card"><h3>Comms Logged</h3><div class="value" id="admin-total-comms">-</div></div>
      </div>
      
      <div class="grid">
        <div class="card">
            <h3>User Management</h3>
            <div id="user-error" class="error"></div>
            <form id="user-form" style="background: transparent; border: none; padding: 0; margin-bottom: 20px;">
            <input id="user-username" placeholder="Username" required />
            <input id="user-fullname" placeholder="Full name" required />
            <select id="user-role" required>
                <option value="">Select Role</option>
                <option>Admin</option>
                <option>Teacher</option>
                <option>Parent</option>
            </select>
            <select id="user-band">
                <option value="">Department (Teacher only)</option>
                <option value="JHS">JHS</option>
                <option value="SHS">SHS</option>
            </select>
            <input id="user-password" type="password" placeholder="Password" required />
            <button type="submit" style="grid-column: 1/-1">Create User</button>
            </form>
            <div style="max-height: 300px; overflow-y: auto;">
                <table id="users-table">
                <thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <div class="card">
            <h3 style="color: var(--danger);">Academic Risk (Lowest Avg)</h3>
            <table>
                <thead><tr><th>Student</th><th>Average %</th></tr></thead>
                <tbody id="admin-low-grades"></tbody>
            </table>
            </div>
            <div class="card">
            <h3 style="color: var(--danger);">Attendance Risk</h3>
            <table>
                <thead><tr><th>Student</th><th>Present %</th><th>Logs</th></tr></thead>
                <tbody id="admin-att-risk"></tbody>
            </table>
            </div>
             <div class="card" style="background: rgba(99, 102, 241, 0.1); border-color: var(--accent);">
                <h3 style="color: var(--accent);">Suggested Focus</h3>
                <ul id="admin-focus" style="color: var(--text); padding-left: 20px; line-height: 1.6;">
                    <li>Monitor attendance outliers</li>
                    <li>Track grade trends per subject</li>
                    <li>Review communications for escalations</li>
                </ul>
            </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = window.location.origin + "/api";
    let attendanceChart, gradesChart, trendChart;
    let studentsCache = [];
    let teachersCache = [];
    let subjectsCache = [];
    let sectionsCache = [];
    let gradeSheetSectionId = null;
    let currentUser = null;
    let usersCache = [];
    let editingSubjectId = null;
    let gradeSheetRows = [];
    let gradeSheetActivities = [];
    let gradeSheetActivitiesBySubject = {};
    let gradesCache = [];
    let teacherBand = null;
    let adminBandFilter = null;
    let gradeSheetSubject = null;
    let gradeSheetRowsData = {}; // {studentId: {activityId: raw}}
    let gradeSheetSubjectWeights = { ww: 0.3, pt: 0.5, qa: 0.2 };

    // --- UI Utilities ---
    function toggleSidebar() {
      const sidebar = document.querySelector("aside");
      const overlay = document.getElementById("sidebar-overlay");
      sidebar.classList.toggle("open");
      overlay.classList.toggle("active");
    }

    function toggleLoading(show) {
      const overlay = document.getElementById("loading-overlay");
      if (show) overlay.classList.add("active");
      else overlay.classList.remove("active");
    }

    function showToast(message, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      
      let icon = "â„¹ï¸";
      if (type === "success") icon = "âœ…";
      if (type === "error") icon = "âš ï¸";

      toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = "fadeOut 0.3s ease forwards";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    // -------------------

    function classifyGradeLevel(gradeStr) {
      if (!gradeStr) return null;
      const m = String(gradeStr).match(/(\d{1,2})/);
      if (!m) return null;
      const g = Number(m[1]);
      if (g >= 7 && g <= 10) return "JHS";
      if (g >= 11 && g <= 12) return "SHS";
      return null;
    }

    function parseGradeNumber(val) {
      const m = String(val || "").match(/(\d{1,2})/);
      return m ? Number(m[1]) : null;
    }

    function inferGradeFromSubjectName(name) {
      const m = String(name || "").match(/(?:grade\s*)?(1[0-2]|[7-9])(?!\d)/i);
      return m ? Number(m[1]) : null;
    }

    function subjectMatchesGrade(subject, gradeNum) {
      if (!subject || !gradeNum) return true;
      const inferred = inferGradeFromSubjectName(subject.name);
      const min = subject.grade_min ?? inferred;
      const max = subject.grade_max ?? inferred;
      const minOk = min == null || gradeNum >= min;
      const maxOk = max == null || gradeNum <= max;
      return minOk && maxOk;
    }

    function logout() {
      localStorage.removeItem("spms_user");
      window.location.href = "index.html";
    }

    function ensureUser() {
      const user = localStorage.getItem("spms_user");
      if (!user) { window.location.href = "index.html"; return null; }
      const parsed = JSON.parse(user);
      document.getElementById("user-name").textContent = parsed.full_name || parsed.username;
      currentUser = parsed;
      if (currentUser.role === "Teacher") {
        teacherBand = currentUser.teacher_band;
        if (!teacherBand || !["JHS", "SHS"].includes(teacherBand)) {
          // fallback to previous local storage only if none set on server
          const cached = localStorage.getItem("spms_teacher_band");
          if (cached && ["JHS","SHS"].includes(cached)) {
            teacherBand = cached;
          } else {
            const picked = window.prompt("Select your level (JHS or SHS):", teacherBand || "JHS");
            if (picked && ["JHS","SHS"].includes(picked.toUpperCase())) {
              teacherBand = picked.toUpperCase();
            } else {
              teacherBand = "JHS";
            }
          }
        }
        localStorage.setItem("spms_teacher_band", teacherBand);
      }
      return parsed;
    }

    function switchTab(tab) {
      document.querySelectorAll("nav button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      document.querySelectorAll(".tab").forEach(sec => {
        sec.classList.toggle("active", sec.id === `tab-${tab}`);
      });
      if (tab === "comms") {
        loadComms(true);
      }
    }

    function filterSelect(selectId, query) {
      const sel = document.getElementById(selectId);
      if (!sel) return;
      const q = (query || "").trim().toLowerCase();
      Array.from(sel.options).forEach(opt => {
        if (opt.value === "") { opt.hidden = false; return; }
        if (!q) { opt.hidden = false; return; }
        const label = (opt.textContent || "").toLowerCase();
        opt.hidden = !label.includes(q);
      });
    }

    // Non-React animated background paths for login-like areas
    function mountBackgroundPaths(targetId, title) {
      const host = document.getElementById(targetId);
      if (!host || host.dataset.bgPaths === "1") return;
      host.dataset.bgPaths = "1";
      host.classList.add("bg-paths-host");

      const wrap = document.createElement("div");
      wrap.className = "bg-paths";
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("viewBox", "0 0 696 316");
      svg.setAttribute("fill", "none");
      svg.setAttribute("aria-hidden", "true");

      const paths = [];
      const makeSet = (position) => {
        Array.from({ length: 36 }, (_, i) => {
          const d = `M-${380 - i * 5 * position} -${189 + i * 6}C-${380 - i * 5 * position} -${189 + i * 6} -${312 - i * 5 * position} ${216 - i * 6} ${152 - i * 5 * position} ${343 - i * 6}C${616 - i * 5 * position} ${470 - i * 6} ${684 - i * 5 * position} ${875 - i * 6} ${684 - i * 5 * position} ${875 - i * 6}`;
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", d);
          path.setAttribute("stroke", "currentColor");
          path.setAttribute("stroke-width", String(0.5 + i * 0.03));
          path.setAttribute("stroke-opacity", String(0.1 + i * 0.03));
          path.style.strokeDasharray = "1200 1200";
          path.style.strokeDashoffset = "1200";
          const duration = 20 + Math.random() * 10;
          path.style.animation = `bg-path-flow ${duration}s linear infinite`;
          paths.push(path);
        });
      };
      makeSet(1);
      makeSet(-1);
      paths.forEach(p => svg.appendChild(p));
      wrap.appendChild(svg);
      host.prepend(wrap);

      if (title) {
        const sr = document.createElement("span");
        sr.className = "sr-only";
        sr.textContent = title;
        host.prepend(sr);
      }
    }

    async function fetchJSON(path, options = {}) {
      const { successMessage, ...rest } = options;
      const headers = { "Content-Type": "application/json" };
      if (currentUser?.role) headers["X-User-Role"] = currentUser.role;
      if (currentUser?.role === "Teacher" && teacherBand) headers["X-Teacher-Band"] = teacherBand;
      if (currentUser?.id) headers["X-User-Id"] = currentUser.id;
      if (currentUser?.full_name) headers["X-User-Name"] = currentUser.full_name;

      toggleLoading(true);
      try {
      const res = await fetch(`${API_BASE}${path}`, {
          headers: { ...headers, ...(rest.headers || {}) },
        ...rest,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Request failed");
      if (successMessage) showToast(successMessage, "success");
      return data;
      } catch (err) {
        if (!options.silent) {
            // Only show toast if not silent (optional)
            // But for now, we usually handle errors in the caller.
            // Let's just rethrow.
        }
        throw err;
      } finally {
        toggleLoading(false);
      }
    }

    function buildAuthHeaders() {
      const headers = {};
      if (currentUser?.role) headers["X-User-Role"] = currentUser.role;
      if (currentUser?.role === "Teacher" && teacherBand) headers["X-Teacher-Band"] = teacherBand;
      if (currentUser?.id) headers["X-User-Id"] = currentUser.id;
      if (currentUser?.full_name) headers["X-User-Name"] = currentUser.full_name;
      return headers;
    }

    async function loadDashboard() {
      const stats = await fetchJSON("/dashboard-stats");
      const totals = stats.totals;
      document.getElementById("total-students").textContent = totals.students;
      document.getElementById("total-grades").textContent = totals.grades;
      document.getElementById("total-behaviors").textContent = totals.behaviors;
      document.getElementById("total-comms").textContent = totals.communications;
      document.getElementById("admin-total-students").textContent = totals.students;
      document.getElementById("admin-total-grades").textContent = totals.grades;
      document.getElementById("admin-total-att").textContent = stats.attendance.Present + stats.attendance.Absent + stats.attendance.Tardy;
      document.getElementById("admin-total-comms").textContent = totals.communications;
      renderAttendance(stats.attendance);
      renderGrades(stats.average_grades);
    }

    async function loadStudents() {
      const students = await fetchJSON("/students");
      const bandFilter = (currentUser?.role === "Teacher") ? teacherBand : adminBandFilter;
      studentsCache = bandFilter
        ? students.filter(s => classifyGradeLevel(s.grade_level) === bandFilter)
        : students;
      const tbody = document.querySelector("#students-table tbody");
      const selectGrade = document.getElementById("grade-student");
      const selectAtt = document.getElementById("attendance-student");
      const selectTrend = document.getElementById("trend-student");
      const selectReport = document.getElementById("report-student");
      const studentSelects = [selectGrade, selectAtt, selectTrend].filter(Boolean);
      if (!tbody) return;
      if (studentSelects.length) {
        studentSelects.forEach(sel => sel.innerHTML = "");
      }
      if (selectReport) selectReport.innerHTML = "";
      const defaultOption = (text) => { const o = document.createElement("option"); o.value = ""; o.textContent = text; o.disabled = true; o.selected = true; return o; };
      if (studentSelects.length) {
        studentSelects.forEach(sel => sel.appendChild(defaultOption("Select student")));
      }
      if (selectReport) selectReport.appendChild(defaultOption("Select student"));
      tbody.innerHTML = "";
      const gradeSectionFilter = Number(document.getElementById("grade-section")?.value) || null;
      const filteredStudents = students.filter(s => !gradeSectionFilter || s.section_id === gradeSectionFilter);
      filteredStudents.forEach((s) => {
        const tr = document.createElement("tr");
        const sec = sectionsCache.find(sec => sec.id === s.section_id);
        const homeroomDisplay = sec?.adviser_name || s.homeroom_teacher || "-";
        tr.innerHTML = `<td>${s.student_number || "-"}</td>
                        <td>${s.first_name} ${s.middle_name ? s.middle_name + ". " : ""}${s.last_name}</td>
                        <td>${s.grade_level || "-"}</td>
                        <td>${homeroomDisplay}</td>
                        <td>${s.date_of_birth ? `DOB: ${s.date_of_birth}` : "-"}</td>
                        <td style="display:flex; gap:8px; flex-wrap:wrap;">
                          <button data-id="${s.id}" class="print-report" style="padding:6px 10px;">Report PDF</button>
                          <button data-id="${s.id}" class="print-schedule" style="padding:6px 10px;">Schedule</button>
                          <button data-id="${s.id}" class="delete-student" style="padding:6px 10px;">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.first_name} ${s.last_name}${s.grade_level ? " (G" + s.grade_level + ")" : ""}`;
        if (studentSelects.length) studentSelects.forEach(sel => sel.appendChild(opt.cloneNode(true)));
        if (selectReport) selectReport.appendChild(opt.cloneNode(true));
      });
      // wire delete buttons
      document.querySelectorAll(".delete-student").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this student (and related records)?")) return;
          try {
          await fetchJSON(`/students/${btn.dataset.id}`, { method: "DELETE" });
          await refreshAll();
            showToast("Student deleted", "success");
          } catch (ex) {
            showToast(ex.message || "Failed to delete student.", "error");
          }
        };
      });
      document.querySelectorAll(".print-report").forEach(btn => {
        btn.onclick = () => downloadStudentReport(Number(btn.dataset.id));
      });
      document.querySelectorAll(".print-schedule").forEach(btn => {
        btn.onclick = () => downloadStudentSchedule(Number(btn.dataset.id));
      });

      // admin students table
      const adminTable = document.querySelector("#admin-students-table tbody");
      const adminSearch = document.getElementById("admin-student-search");
      if (adminTable) {
        const renderAdminStudents = (term = "") => {
          const q = term.toLowerCase();
          adminTable.innerHTML = "";
          studentsCache
            .filter(s => `${s.first_name} ${s.last_name} ${s.student_number}`.toLowerCase().includes(q))
            .slice(0, 200)
            .forEach(s => {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${s.student_number || "-"}</td>
                              <td>${s.first_name} ${s.last_name}</td>
                              <td>${s.grade_level || "-"}</td>
                              <td>${s.section_id || "-"}</td>`;
              adminTable.appendChild(tr);
            });
        };
        renderAdminStudents();
        if (adminSearch) {
          adminSearch.oninput = (e) => renderAdminStudents(e.target.value);
        }
      }
    }

    async function loadSubjects() {
      const subjects = await fetchJSON("/subjects");
      const bandFilter = (currentUser?.role === "Teacher") ? teacherBand : adminBandFilter;
      const teacherId = currentUser?.role === "Teacher" ? currentUser.id : null;
      subjectsCache = subjects
        .filter(s => !bandFilter || s.level_band === bandFilter)
        .filter(s => !teacherId || s.teacher_id === teacherId);
      const teacherLookup = Object.fromEntries(usersCache.map(u => [u.id, u.full_name || u.username]));
      const teacherSelect = document.getElementById("sub-teacher");
      if (teacherSelect) {
        teacherSelect.innerHTML = `<option value="">Assign teacher (optional)</option>`;
        usersCache.filter(u => u.role === "Teacher" && u.approved).forEach(t => {
          teacherSelect.innerHTML += `<option value="${t.id}">${t.full_name || t.username}</option>`;
        });
      }
      const tbody = document.querySelector("#subjects-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      subjects.forEach(sub => {
        const tr = document.createElement("tr");
        const gradeLabel = sub.grade_min && sub.grade_max
          ? `${sub.grade_min}-${sub.grade_max}`
          : (sub.grade_min || sub.grade_max || "-");
        tr.innerHTML = `<td>${sub.name}</td>
                        <td>${sub.level_band}</td>
                        <td>${sub.category}</td>
                        <td>${sub.track || "-"}</td>
                        <td>${sub.teacher_id ? (teacherLookup[sub.teacher_id] || sub.teacher_id) : "-"}</td>
                        <td>${gradeLabel}</td>
                        <td style="display:flex; gap:8px;">
                          <button class="edit-subject" data-id="${sub.id}" style="padding:6px 10px; background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3);">Edit</button>
                          <button class="delete-subject" data-id="${sub.id}" style="padding:6px 10px;">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll(".edit-subject").forEach(btn => {
        btn.onclick = () => {
          const sub = subjectsCache.find(s => s.id === Number(btn.dataset.id));
          if (!sub) return;
          editingSubjectId = sub.id;
          document.getElementById("sub-id").value = sub.id;
          document.getElementById("sub-name").value = sub.name;
          document.getElementById("sub-level").value = sub.level_band;
          document.getElementById("sub-category").value = sub.category;
          document.getElementById("sub-track").value = sub.track || "";
          document.getElementById("sub-grade-min").value = sub.grade_min ?? "";
          document.getElementById("sub-grade-max").value = sub.grade_max ?? "";
          document.getElementById("sub-teacher").value = sub.teacher_id || "";
          document.getElementById("sub-submit").textContent = "Update Subject";
          document.getElementById("sub-cancel").style.display = "inline-block";
          document.getElementById("subject-error").textContent = "";
        };
      });
      document.querySelectorAll(".delete-subject").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this subject?")) return;
          try {
            await fetchJSON(`/subjects/${btn.dataset.id}`, { method: "DELETE" });
            await loadSubjects();
            populateGradeSubjects();
            showToast("Subject deleted", "success");
          } catch (ex) {
            showToast(ex.message || "Failed to delete subject.", "error");
          }
        };
      });

      // populate grade sheet subject dropdown
      const sheetSelect = document.getElementById("sheet-subject");
      if (sheetSelect) {
        sheetSelect.innerHTML = "";
        const mkOpt = (val, text, disabled = false, selected = false) => {
          const o = document.createElement("option");
          o.value = val;
          o.textContent = text;
          o.disabled = disabled;
          if (selected) o.selected = true;
          return o;
        };
        sheetSelect.appendChild(mkOpt("", "Select subject", true, true));
        const teacherId = currentUser?.role === "Teacher" ? currentUser.id : null;
        const selectedSectionId = Number(document.getElementById("sheet-section")?.value) || gradeSheetSectionId;
        const selectedSection = sectionsCache.find(s => s.id === selectedSectionId);
        const sectionBand = classifyGradeLevel(selectedSection?.grade_level || selectedSection?.name);
        const sectionGradeNum = parseGradeNumber(selectedSection?.grade_level || selectedSection?.name);
        subjects
          .filter(sub => !teacherId || sub.teacher_id === teacherId)
          .filter(sub => !sectionBand || sub.level_band === sectionBand)
          .filter(sub => subjectMatchesGrade(sub, sectionGradeNum))
          .forEach(sub => {
            sheetSelect.appendChild(mkOpt(sub.name, `${sub.name} (${sub.level_band}${sub.category ? " â€¢ " + sub.category : ""}${sub.track ? " â€¢ " + sub.track : ""})`));
          });
      }

      // populate grades tab subject filter
      const gradeSubSel = document.getElementById("grade-subject");
      if (gradeSubSel) {
        const current = gradeSubSel.value;
        gradeSubSel.innerHTML = "";
        const mkOpt2 = (val, text, selected = false) => {
          const o = document.createElement("option");
          o.value = val;
          o.textContent = text;
          if (selected) o.selected = true;
          return o;
        };
        gradeSubSel.appendChild(mkOpt2("", "All subjects", !current));
        subjects.forEach(sub => {
          gradeSubSel.appendChild(mkOpt2(sub.name, sub.name, current === sub.name));
        });
      }

      // populate attendance subject filter
      const attendanceSubjectSel = document.getElementById("attendance-subject");
      if (attendanceSubjectSel) {
        attendanceSubjectSel.innerHTML = `<option value="">All subjects</option>`;
        const teacherId = currentUser?.role === "Teacher" ? currentUser.id : null;
        subjects
          .filter(sub => !teacherId || sub.teacher_id === teacherId)
          .forEach(sub => {
            attendanceSubjectSel.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
          });
      }
    }

    function populateGradeSubjects() {
      const select = document.getElementById("grade-subject");
      if (!select) return;
      const studentId = Number(document.getElementById("grade-student").value);
      const student = studentsCache.find(s => s.id === studentId);
      const band = classifyGradeLevel(student?.grade_level);
      const gradeNum = parseGradeNumber(student?.grade_level);
      select.innerHTML = "";
      const mkOpt = (val, text, disabled = false, selected = false) => {
        const o = document.createElement("option");
        o.value = val;
        o.textContent = text;
        o.disabled = disabled;
        if (selected) o.selected = true;
        return o;
      };
      if (!band) {
        select.appendChild(mkOpt("", "Select a student to filter subjects", true, true));
        return;
      }
      select.appendChild(mkOpt("", `Select ${band} subject`, true, true));
      const teacherId = currentUser?.role === "Teacher" ? currentUser.id : null;
      const filtered = subjectsCache
        .filter(s => s.level_band === band)
        .filter(s => subjectMatchesGrade(s, gradeNum))
        .filter(s => !teacherId || s.teacher_id === teacherId);
      if (filtered.length === 0) {
        select.appendChild(mkOpt("", `No ${band} subjects available`, true, true));
        return;
      }
      filtered.forEach(sub => {
        select.appendChild(mkOpt(sub.name, `${sub.name} (${sub.category}${sub.track ? " â€¢ " + sub.track : ""})`));
      });
      computeGradeTotal();
    }

    function getWeightsForSubject(subjectName, subjectMeta, band) {
      if (!band) return null;
      const name = (subjectName || "").toLowerCase();
      const track = (subjectMeta?.track || "").toLowerCase();
      // JHS rules
      if (band === "JHS") {
        const groupA = ["english","filipino","araling panlipunan","social studies","esp","edukasyon sa pagpapakatao"];
        const groupB = ["science","math","mathematics"];
        const groupC = ["mapeh","music","arts","physical education","pe","health","tle","technology & livelihood education","computer","ict","livelihood"];
        if (groupA.some(x => name.includes(x))) return { ww:30, pt:50, qa:20 };
        if (groupB.some(x => name.includes(x))) return { ww:40, pt:40, qa:20 };
        if (groupC.some(x => name.includes(x))) return { ww:20, pt:60, qa:20 };
        return { ww:30, pt:50, qa:20 }; // default JHS
      }
      // SHS rules
      if (band === "SHS") {
        const isCore = subjectMeta?.category === "Core";
        const isWorkImmersion = name.includes("work immersion") || name.includes("research") || name.includes("capstone");
        const acadTracks = ["stem","abm","humss","gas"];
        const isAcad = acadTracks.includes(track);
        const tvlTracks = ["ict","tvl","sports","arts","design","institutional"];
        const isTvl = tvlTracks.includes(track);
        if (isCore) return { ww:25, pt:50, qa:25 };
        if (isAcad) {
          if (isWorkImmersion) return { ww:35, pt:40, qa:25 };
          return { ww:25, pt:45, qa:30 };
        }
        if (isTvl) {
          return { ww:20, pt:60, qa:20 };
        }
        // fallback SHS
        return { ww:25, pt:50, qa:25 };
      }
      return null;
    }

    function computeGradeTotal() {
      const studentSel = document.getElementById("grade-student");
      const subjectSel = document.getElementById("grade-subject");
      const wwEl = document.getElementById("grade-ww");
      const ptEl = document.getElementById("grade-pt");
      const qaEl = document.getElementById("grade-qa");
      const weightLabel = document.getElementById("grade-weights");
      const valueEl = document.getElementById("grade-value");
      // If the old single-entry controls are not present, safely exit.
      if (!studentSel || !subjectSel || !wwEl || !ptEl || !qaEl || !weightLabel || !valueEl) return;

      const studentId = Number(studentSel.value);
      const student = studentsCache.find(s => s.id === studentId);
      const band = classifyGradeLevel(student?.grade_level);
      const subjectName = subjectSel.value;
      const subjectMeta = subjectsCache.find(s => s.name === subjectName);
      const weights = getWeightsForSubject(subjectName, subjectMeta, band);
      const ww = Number(wwEl.value) || 0;
      const pt = Number(ptEl.value) || 0;
      const qa = Number(qaEl.value) || 0;

      if (!weights) {
        weightLabel.textContent = "Weights: select a student and subject";
        valueEl.value = "";
        return;
      }
      weightLabel.textContent = `Weights: WW ${weights.ww}%, PT ${weights.pt}%, QA ${weights.qa}%`;
      const total = ((ww * weights.ww) + (pt * weights.pt) + (qa * weights.qa)) / 100;
      valueEl.value = total ? total.toFixed(2) : "";
    }

    function downloadStudentReport(forcedId) {
      const studentId = forcedId ?? Number(document.getElementById("grade-student")?.value);
      const student = studentsCache.find(s => s.id === studentId);
      if (!student) { showToast("Select a student.", "error"); return; }
      fetchJSON(`/report-card?student_id=${studentId}`)
        .then(rc => {
          const rows = (rc.subjects || []).map(g => `<tr><td>${g.subject}</td><td>${g.average}</td><td>${g.entries}</td></tr>`).join("");
          const html = `
            <html><head><title>Report Card - ${student.first_name} ${student.last_name}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 24px; }
              h2 { margin: 0 0 8px; }
              table { border-collapse: collapse; width: 100%; margin-top: 12px; }
              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
              th { background: #f4f4f4; }
            </style>
            </head><body>
            <h2>Report Card</h2>
            <div><strong>Name:</strong> ${student.first_name} ${student.last_name}</div>
            <div><strong>Grade Level:</strong> ${student.grade_level || "-"}</div>
            <table>
              <thead><tr><th>Subject</th><th>Average %</th><th>Entries</th></tr></thead>
              <tbody>${rows || "<tr><td colspan='3'>No grades yet.</td></tr>"}</tbody>
            </table>
            </body></html>`;
          const win = window.open("", "_blank");
          if (!win) { showToast("Popup blocked. Allow popups to download PDF/print.", "error"); return; }
          win.document.write(html);
          win.document.close();
          win.focus();
          win.print();
        })
        .catch(err => showToast(err.message || "Failed to load report card", "error"));
    }

    function addGradeSheetActivity() {
      const subjectName = gradeSheetSubject || document.getElementById("sheet-subject").value;
      if (!subjectName) { showToast("Select a subject first.", "error"); return; }
      const name = prompt("Activity name (e.g., Quiz 1):", "");
      if (!name) return;
      const max = Number(prompt("Max score:", "20"));
      if (!max || max <= 0) { showToast("Max score must be > 0", "error"); return; }
      const comp = prompt("Component (WW/PT/QA):", "WW");
      const compNorm = (comp || "").toUpperCase();
      if (!["WW","PT","QA"].includes(compNorm)) { showToast("Component must be WW, PT, or QA", "error"); return; }
      const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random();
      const list = gradeSheetActivitiesBySubject[subjectName] || [];
      list.push({ id, label: name, type: compNorm, max_score: max });
      gradeSheetActivitiesBySubject[subjectName] = list;
      rebuildGradeSheetFromData();
    }

    function rebuildGradeSheetFromData() {
      const subjectName = gradeSheetSubject || document.getElementById("sheet-subject").value;
      const subjectMeta = subjectsCache.find(s => s.name === subjectName);
      const band = subjectMeta?.level_band;
      const selectedSectionId = Number(document.getElementById("sheet-section")?.value) || gradeSheetSectionId;
      const selectedSection = sectionsCache.find(s => s.id === selectedSectionId);
      const selectedSectionGrade = parseGradeNumber(selectedSection?.grade_level || selectedSection?.name);
      gradeSheetActivities = gradeSheetActivitiesBySubject[subjectName] ? [...gradeSheetActivitiesBySubject[subjectName]] : [];
      gradeSheetSubject = subjectName;
      updateSheetSectionOptions(band || null);
      syncScheduleSectionSelect();
      const sheetError = document.getElementById("sheet-error");
      const tbody = document.querySelector("#sheet-table tbody");
      const theadRow = document.getElementById("sheet-header-row");
      const weightsLabel = document.getElementById("sheet-weights");
      // preserve any in-progress edits before rebuilding
      const draftScores = {};
      document.querySelectorAll("#sheet-table tbody input[data-id][data-act]").forEach(inp => {
        const sid = Number(inp.dataset.id);
        const actId = inp.dataset.act;
        if (!draftScores[sid]) draftScores[sid] = {};
        draftScores[sid][actId] = inp.value;
      });
      tbody.innerHTML = "";
      theadRow.innerHTML = "<th>Student</th>";

      // infer weights
      const weights = subjectMeta ? {
        ww: Number(subjectMeta.weight_ww || 0),
        pt: Number(subjectMeta.weight_pt || 0),
        qa: Number(subjectMeta.weight_qa || 0),
      } : gradeSheetSubjectWeights;
      if (!weights || (weights.ww + weights.pt + weights.qa) === 0) {
        weightsLabel.textContent = "Weights: not set on subject";
      } else {
        weightsLabel.textContent = `Weights: WW ${weights.ww*100}% , PT ${weights.pt*100}% , QA ${weights.qa*100}%`;
      }

      // build activities from existing grades for this subject
      if (subjectName) {
        const existing = gradesCache.filter(g => g.subject === subjectName);
        existing.forEach(g => {
          if (!gradeSheetActivities.find(a => a.label === g.assessment)) {
            gradeSheetActivities.push({
              id: g.assessment,
              label: g.assessment,
              type: g.component || "WW",
              max_score: g.max_score || 0,
            });
          }
        });
      }
      gradeSheetActivitiesBySubject[subjectName] = gradeSheetActivities;

      // header columns
      gradeSheetActivities.forEach(act => {
        const th = document.createElement("th");
        th.textContent = `${act.label} (${act.type}, Max ${act.max_score || 0})`;
        theadRow.appendChild(th);
      });
      theadRow.innerHTML += "<th>Final</th>";

      // students eligible
      const bandFilter = (currentUser?.role === "Teacher") ? band : (band || null);
      const eligible = bandFilter
        ? studentsCache.filter(s => classifyGradeLevel(s.grade_level) === bandFilter && subjectMatchesGrade(subjectMeta, parseGradeNumber(s.grade_level)))
        : studentsCache.filter(s => subjectMatchesGrade(subjectMeta, parseGradeNumber(s.grade_level)));
      const sectionSel = document.getElementById("sheet-section");
      const secFilter = Number(sectionSel?.value) || null;
      const eligibleFiltered = secFilter ? eligible.filter(s => s.section_id === secFilter) : eligible;
      if (eligibleFiltered.length === 0) {
        sheetError.textContent = `No students for ${secFilter ? "this section" : (bandFilter || "this")} level.`;
        return;
      }
      sheetError.textContent = "";

      gradeSheetRows = [];
      gradeSheetRowsData = {};
      eligibleFiltered.forEach(s => {
        const row = { student_id: s.id, scores: {} };
        gradeSheetRows.push(row);
        gradeSheetRowsData[s.id] = {};
        const tr = document.createElement("tr");
        let cells = `<td>${s.first_name} ${s.last_name}${s.grade_level ? " (G" + s.grade_level + ")" : ""}</td>`;
        gradeSheetActivities.forEach(act => {
          // prefill from existing grades
          const existing = gradesCache.find(g => g.student_id === s.id && g.subject === subjectName && g.assessment === act.label);
          const draftVal = draftScores[s.id]?.[act.id];
          const val = draftVal !== undefined ? draftVal : (existing ? existing.raw_score : "");
          row.scores[act.id] = val;
          gradeSheetRowsData[s.id][act.id] = val;
          cells += `<td><input data-id="${s.id}" data-act="${act.id}" type="number" step="0.01" min="0" max="${act.max_score || 0}" style="width:100%;" value="${val}"></td>`;
        });
        cells += `<td><input data-id="${s.id}" data-field="final" type="number" step="0.01" min="0" max="100" style="width:100%;" readonly></td>`;
        tr.innerHTML = cells;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("input[data-act]").forEach(inp => {
        inp.addEventListener("input", () => {
          const sid = Number(inp.dataset.id);
          const act = inp.dataset.act;
          const maxVal = Number(inp.max);
          const minVal = Number(inp.min);
          let currentVal = Number(inp.value);
          if (!isNaN(maxVal) && currentVal > maxVal) {
            currentVal = maxVal;
            inp.value = String(maxVal);
          }
          if (!isNaN(minVal) && currentVal < minVal) {
            currentVal = minVal;
            inp.value = String(minVal);
          }
          const row = gradeSheetRows.find(r => r.student_id === sid);
          if (!row) return;
          row.scores[act] = inp.value;
          gradeSheetRowsData[sid][act] = inp.value;
          computeSheetFinals();
        });
      });
      computeSheetFinals();
    }

    function computeSheetFinals() {
      const subjectName = gradeSheetSubject || document.getElementById("sheet-subject").value;
      const subjectMeta = subjectsCache.find(s => s.name === subjectName);
      const weights = subjectMeta ? {
        ww: Number(subjectMeta.weight_ww || 0),
        pt: Number(subjectMeta.weight_pt || 0),
        qa: Number(subjectMeta.weight_qa || 0),
      } : gradeSheetSubjectWeights;
      gradeSheetRows.forEach(row => {
        let wwRaw = 0, wwMax = 0, ptRaw = 0, ptMax = 0, qaRaw = 0, qaMax = 0;
        gradeSheetActivities.forEach(act => {
          const v = Number(row.scores[act.id]);
          const mx = Number(act.max_score || 0);
          if (isNaN(v) || isNaN(mx)) return;
          if (act.type === "WW") { wwRaw += v; wwMax += mx; }
          if (act.type === "PT") { ptRaw += v; ptMax += mx; }
          if (act.type === "QA") { qaRaw += v; qaMax += mx; }
        });
        const pct = (raw, mx) => mx > 0 ? (raw / mx) * 100 : 0;
        const wwPct = pct(wwRaw, wwMax);
        const ptPct = pct(ptRaw, ptMax);
        const qaPct = pct(qaRaw, qaMax);
        let final = "";
        if (weights) {
          final = ((wwPct * weights.ww) + (ptPct * weights.pt) + (qaPct * weights.qa));
          final = isNaN(final) ? "" : final.toFixed(2);
        }
        row.final = final;
        const finalInput = document.querySelector(`#sheet-table input[data-id="${row.student_id}"][data-field="final"]`);
        if (finalInput) finalInput.value = final;
      });
    }

    async function loadSections() {
      const sections = await fetchJSON("/sections");
      sectionsCache = sections;
      renderSectionsTable();
      populateSectionSelects();

      // Populate student section select on the student form
      const studentSection = document.getElementById("student-section");
      if (studentSection) {
        const currentVal = studentSection.value;
        studentSection.innerHTML = `<option value="">Section (optional)</option>`;
        sectionsCache.forEach(sec => {
          const opt = document.createElement("option");
          opt.value = sec.id;
          opt.textContent = sec.name;
          studentSection.appendChild(opt);
        });
        if (currentVal) studentSection.value = currentVal;
      }
    }

    function renderSectionsTable() {
      const tbody = document.querySelector("#sections-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      sectionsCache.forEach(sec => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${sec.name}</td>
                        <td>${sec.level_band || "-"}</td>
                        <td>${sec.grade_level || "-"}</td>
                        <td>${sec.track || "-"}</td>
                        <td>${sec.adviser_name || "-"}</td>
                        <td>${sec.student_count || 0}</td>
                        <td style="display:flex; gap:6px;">
                          <button class="section-delete" data-id="${sec.id}" style="padding:6px 10px;">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll(".section-delete").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (!confirm("Delete section? Students will be unassigned.")) return;
          try {
            await fetchJSON(`/sections/${btn.dataset.id}`, { method: "DELETE" });
            await loadSections();
            await refreshAll();
          } catch (ex) {
            document.getElementById("section-error").textContent = ex.message;
          }
        });
      });
    }

    function populateSectionSelects() {
      const adviserSel = document.getElementById("section-adviser");
      if (adviserSel) {
        adviserSel.innerHTML = `<option value="">Adviser (optional)</option>`;
        usersCache.filter(u => u.role === "Teacher" && u.approved).forEach(t => {
          adviserSel.innerHTML += `<option value="${t.id}">${t.full_name || t.username}</option>`;
        });
      }
      const sectionSel = document.getElementById("assign-section");
      if (sectionSel) {
        sectionSel.innerHTML = `<option value="">Select section</option>`;
        sectionsCache.forEach(s => {
          sectionSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      }
      const studentSel = document.getElementById("assign-student");
      updateAssignStudentOptions();
      const gradeSectionSel = document.getElementById("grade-section");
      if (gradeSectionSel) {
        gradeSectionSel.innerHTML = `<option value="">All sections</option>`;
        sectionsCache.forEach(s => {
          gradeSectionSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      }
      const sheetSectionSel = document.getElementById("sheet-section");
      if (sheetSectionSel) {
        updateSheetSectionOptions();
      }
      const attendanceSectionSel = document.getElementById("attendance-section");
      if (attendanceSectionSel) {
        attendanceSectionSel.innerHTML = `<option value="">All sections</option>`;
        sectionsCache.forEach(s => {
          attendanceSectionSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      }
      updateSectionRoster();
    }

    function sectionMatchesBand(section, band) {
      if (!band) return true;
      const lvl = section?.grade_level || "";
      const m = String(lvl).match(/(\d+)/);
      if (!m) return false;
      const g = Number(m[1]);
      if (band === "JHS") return g >= 7 && g <= 10;
      if (band === "SHS") return g >= 11 && g <= 12;
      return true;
    }

    function updateSheetSectionOptions(band = null) {
      const sheetSectionSel = document.getElementById("sheet-section");
      if (!sheetSectionSel) return;
      const current = sheetSectionSel.value;
      sheetSectionSel.innerHTML = `<option value="">All sections</option>`;
      sectionsCache
        .filter(s => sectionMatchesBand(s, band))
        .forEach(s => {
          sheetSectionSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      // preserve previous selection if still valid
      if (current && Array.from(sheetSectionSel.options).some(o => o.value === current)) {
        sheetSectionSel.value = current;
      }
    }

    function updateScheduleSectionSelect() {
      const sel = document.getElementById("schedule-section");
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = `<option value="">Select section</option>`;
      sectionsCache.forEach(s => {
        sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
      });
      if (current && Array.from(sel.options).some(o => o.value === current)) {
        sel.value = current;
      }
    }

    function updateSectionRoster() {
      const sectionSel = document.getElementById("assign-section");
      const rosterBody = document.getElementById("section-roster-body");
      if (!sectionSel || !rosterBody) return;
      rosterBody.innerHTML = "";
      const secId = Number(sectionSel.value);
      if (!secId) return;
      const roster = studentsCache.filter(s => s.section_id === secId);
      roster.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.first_name} ${s.last_name}</td><td>${s.grade_level || "-"}</td>`;
        rosterBody.appendChild(tr);
      });
      loadSectionSchedule();
    }

    function updateAssignStudentOptions() {
      const sectionSel = document.getElementById("assign-section");
      const studentSel = document.getElementById("assign-student");
      if (!studentSel) return;
      studentSel.innerHTML = `<option value="">Select student</option>`;
      const secId = Number(sectionSel?.value);
      const section = sectionsCache.find(s => s.id === secId);
      let sectionGrade = null;
      if (section && section.grade_level) {
        const m = String(section.grade_level).match(/(\d+)/);
        sectionGrade = m ? m[1] : null;
      }
      studentsCache
        .filter(st => {
          if (!sectionGrade) return true;
          const gm = String(st.grade_level || "").match(/(\d+)/);
          return gm && gm[1] === sectionGrade;
        })
        .forEach(st => {
          studentSel.innerHTML += `<option value="${st.id}">${st.first_name} ${st.last_name} ${st.grade_level ? "(G"+st.grade_level+")" : ""}</option>`;
        });
    }

    async function assignStudentToSection() {
      const secId = Number(document.getElementById("assign-section").value);
      const studentId = Number(document.getElementById("assign-student").value);
      const err = document.getElementById("section-error");
      err.textContent = "";
      err.style.display = "none";
      if (!secId || !studentId) { err.textContent = "Pick section and student."; err.style.display = "block"; return; }
      try {
        await fetchJSON(`/sections/${secId}/students`, {
          method: "POST",
          body: JSON.stringify({ student_ids: [studentId] }),
          successMessage: "Student assigned to section",
        });
        await refreshAll();
        document.getElementById("assign-student").value = "";
      } catch (ex) {
        err.textContent = ex.message;
        err.style.display = "block";
      }
    }

    // Alias for legacy call sites
    function buildGradeSheet() {
      return rebuildGradeSheetFromData();
    }

    function resetGradeSheetInputs() {
      gradeSheetRows.forEach(r => { r.scores = {}; r.final = ""; });
      document.querySelectorAll("#sheet-table tbody input").forEach(inp => {
        inp.value = "";
      });
      computeSheetFinals();
    }

    async function saveGradeSheetBulk() {
      const subjectName = document.getElementById("sheet-subject").value;
      const sheetError = document.getElementById("sheet-error");
      sheetError.textContent = "";
      if (!subjectName) { sheetError.textContent = "Select a subject."; return; }
      if (gradeSheetActivities.length === 0) { sheetError.textContent = "Add at least one activity."; return; }
      const payloads = [];
      gradeSheetRows.forEach(r => {
        gradeSheetActivities.forEach(act => {
          const val = r.scores[act.id];
          if (val !== undefined && val !== "") {
            payloads.push({
              student_id: r.student_id,
              subject: subjectName,
              assessment: act.label,
              component: act.type,
              raw_score: Number(val),
              max_score: Number(act.max_score || 0),
              recorded_on: new Date().toISOString().slice(0,10),
              recorded_by: currentUser?.id,
            });
          }
        });
      });
      if (payloads.length === 0) { sheetError.textContent = "Enter at least one score."; return; }
      try {
        await fetchJSON("/grades/bulk", { method: "POST", body: JSON.stringify(payloads), successMessage: "Grades saved" });
        document.getElementById("sheet-status").textContent = "Saved.";
        await refreshAll();
      } catch (ex) {
        sheetError.textContent = ex.message;
      }
    }

    function aggregateFinalGrades(grades) {
      const map = new Map();
      grades.forEach(g => {
        const key = `${g.student_id}__${g.subject}`;
        if (!map.has(key)) {
          map.set(key, {
            student_id: g.student_id,
            subject: g.subject,
            ww: [],
            pt: [],
            qa: [],
            manualFinal: null,
            finalRecordId: null,
          });
        }
        const entry = map.get(key);
        const comp = (g.component || "").toUpperCase();
        const assess = (g.assessment || "").toLowerCase();
        if (comp === "FINAL" || assess.includes("final grade")) {
          entry.manualFinal = Number(g.grade_value);
          entry.finalRecordId = g.id;
          return;
        }
        if (comp === "WW") entry.ww.push(Number(g.grade_value));
        if (comp === "PT") entry.pt.push(Number(g.grade_value));
        if (comp === "QA") entry.qa.push(Number(g.grade_value));
      });

      return Array.from(map.values()).map(entry => {
        const subjectMeta = subjectsCache.find(s => s.name === entry.subject);
        const band = classifyGradeLevel(
          studentsCache.find(s => s.id === entry.student_id)?.grade_level
        );
        const weights = subjectMeta
          ? {
              ww: (subjectMeta.weight_ww || 0) * 100,
              pt: (subjectMeta.weight_pt || 0) * 100,
              qa: (subjectMeta.weight_qa || 0) * 100,
            }
          : getWeightsForSubject(entry.subject, subjectMeta, band);
        const avg = arr => (arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null);
        const wwAvg = avg(entry.ww);
        const ptAvg = avg(entry.pt);
        const qaAvg = avg(entry.qa);
        let finalVal = entry.manualFinal;
        if (finalVal == null) {
          const parts = [];
          if (wwAvg != null && weights?.ww) parts.push(wwAvg * (weights.ww/100));
          if (ptAvg != null && weights?.pt) parts.push(ptAvg * (weights.pt/100));
          if (qaAvg != null && weights?.qa) parts.push(qaAvg * (weights.qa/100));
          if (parts.length > 0 && weights) {
            finalVal = parts.reduce((a,b)=>a+b,0);
          } else {
            const raw = [wwAvg, ptAvg, qaAvg].filter(v => v != null);
            finalVal = raw.length ? raw.reduce((a,b)=>a+b,0) / raw.length : null;
          }
        }
        return {
          ...entry,
          wwAvg,
          ptAvg,
          qaAvg,
          final: finalVal,
          count: entry.ww.length + entry.pt.length + entry.qa.length,
        };
      });
    }

    async function saveFinalGrade(entry) {
      const payload = {
        student_id: entry.student_id,
        subject: entry.subject,
        assessment: "Final Grade",
        component: "FINAL",
        grade_value: Number(entry.final?.toFixed(2) || 0),
        recorded_on: new Date().toISOString().slice(0,10),
        recorded_by: currentUser?.id,
      };
      if (entry.finalRecordId) {
        await fetchJSON(`/grades/${entry.finalRecordId}`, { method: "PUT", body: JSON.stringify(payload), successMessage: "Final grade updated" });
      } else {
        await fetchJSON("/grades", { method: "POST", body: JSON.stringify(payload), successMessage: "Final grade saved" });
      }
    }

    async function deleteFinalGrade(id) {
      if (!id) return;
      await fetchJSON(`/grades/${id}`, { method: "DELETE", successMessage: "Final grade deleted" });
    }

    async function loadGradesTable() {
      const grades = await fetchJSON("/grades");
      gradesCache = grades;
      const tbody = document.querySelector("#grades-table tbody");
      const statusEl = document.getElementById("grade-status");
      tbody.innerHTML = "";
      const sectionFilter = Number(document.getElementById("grade-section")?.value) || null;
      const studentFilter = Number(document.getElementById("grade-student").value) || null;
      const subjectFilter = document.getElementById("grade-subject").value || "";
      const filtered = grades.filter(g => {
        if (studentFilter && g.student_id !== studentFilter) return false;
        if (subjectFilter && g.subject !== subjectFilter) return false;
        if (sectionFilter) {
          const st = studentsCache.find(st => st.id === g.student_id);
          if ((st?.section_id || null) !== sectionFilter) return false;
        }
        if (currentUser?.role === "Teacher" && teacherBand) {
          const s = studentsCache.find(st => st.id === g.student_id);
          if (classifyGradeLevel(s?.grade_level) !== teacherBand) return false;
        }
        return true;
      });

      const summaries = aggregateFinalGrades(filtered);
      if (!summaries.length) {
        tbody.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:12px;'>No grade data yet.</td></tr>";
        statusEl.textContent = "";
        return;
      }
      statusEl.textContent = `Showing ${summaries.length} final grade rows`;
      summaries.slice(0, 200).forEach((entry, idx) => {
        const st = studentsCache.find(s => s.id === entry.student_id);
        const studentName = st ? `${st.first_name} ${st.last_name}` : entry.student_id;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${studentName}</td>
                        <td>${entry.subject}</td>
                        <td>${entry.wwAvg != null ? entry.wwAvg.toFixed(2) : "-"}</td>
                        <td>${entry.ptAvg != null ? entry.ptAvg.toFixed(2) : "-"}</td>
                        <td>${entry.qaAvg != null ? entry.qaAvg.toFixed(2) : "-"}</td>
                        <td>${entry.final != null ? entry.final.toFixed(2) : "-"}</td>
                        <td>${entry.count}</td>
                        <td style="display:flex; gap:6px; flex-wrap:wrap;">
                          <button class="final-save" data-idx="${idx}" style="padding:6px 10px; background: var(--accent); border:none; color:white; border-radius:8px;">${entry.finalRecordId ? "Update" : "Save"}</button>
                          <button class="final-delete" data-id="${entry.finalRecordId || ""}" ${entry.finalRecordId ? "" : "disabled"} style="padding:6px 10px; background: rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4); color:#fecdd3; border-radius:8px;">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".final-save").forEach(btn => {
        btn.addEventListener("click", async () => {
          const idx = Number(btn.dataset.idx);
          const entry = summaries[idx];
          try {
            await saveFinalGrade(entry);
            await loadGradesTable();
      } catch (ex) {
        const err = document.getElementById("grade-error");
        err.textContent = ex.message;
        err.style.display = "block";
      }
        });
      });
      tbody.querySelectorAll(".final-delete").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (!id) return;
          try {
            await deleteFinalGrade(id);
            await loadGradesTable();
          } catch (ex) {
            document.getElementById("grade-error").textContent = ex.message;
          }
        });
      });
    }

    function todayStr() {
      return new Date().toISOString().slice(0,10);
    }

    function setTodayAttendanceDate() {
      const d = document.getElementById("attendance-date");
      if (d) {
        d.value = todayStr();
        d.max = d.value;
        d.min = d.value;
      }
    }

    function updateLiveClock() {
      const el = document.getElementById("attendance-clock");
      if (!el) return;
      const now = new Date();
      el.textContent = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    const classTimeSlots = ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"];

    function buildTeacherSchedulePreview() {
      if (!currentUser || currentUser.role !== "Teacher") return [];
      const mySubs = subjectsCache.filter(s => s.teacher_id === currentUser.id);
      let slotIdx = 0;
      const sched = [];
      mySubs.forEach(sub => {
        const secs = sectionsCache.filter(sec => sectionMatchesBand(sec, sub.level_band || classifyGradeLevel(sec.grade_level)));
        secs.forEach(sec => {
          const slot = classTimeSlots[slotIdx % classTimeSlots.length];
          sched.push({ section: sec.name, subject: sub.name, time: slot });
          slotIdx++;
        });
      });
      return sched;
    }

    function renderNextClassForTeacher() {
      const label = document.getElementById("next-class-label");
      const val = document.getElementById("next-class-value");
      if (!label || !val) return;
      if (!currentUser || currentUser.role !== "Teacher") {
        label.style.display = "none";
        return;
      }
      const sched = buildTeacherSchedulePreview();
      if (!sched.length) {
        label.style.display = "none";
        return;
      }
      const now = new Date();
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      let next = null;
      sched.forEach(entry => {
        const [h, m] = entry.time.split(":").map(Number);
        const mins = h * 60 + m;
        if (mins >= nowMinutes && (!next || mins < next.mins)) {
          next = { ...entry, mins };
        }
      });
      if (!next) {
        // no more classes today; pick earliest for tomorrow
        const first = sched.reduce((acc, e) => {
          const [h, m] = e.time.split(":").map(Number);
          const mins = h * 60 + m;
          if (!acc || mins < acc.mins) return { ...e, mins };
          return acc;
        }, null);
        if (first) {
          label.style.display = "inline";
          val.textContent = `Tomorrow ${first.time} â€” ${first.subject} (${first.section})`;
        } else {
          label.style.display = "none";
        }
      } else {
        label.style.display = "inline";
        val.textContent = `${next.time} â€” ${next.subject} (${next.section})`;
      }
    }

    async function updateAttendanceStatus(id, status) {
      if (!id) return;
      await fetchJSON(`/attendance/${id}`, {
        method: "PUT",
        body: JSON.stringify({ status })
      });
    }

    async function loadAttendanceTable() {
      const records = await fetchJSON("/attendance");
      const todayTable = document.querySelector("#attendance-today-table tbody");
      const historyTable = document.querySelector("#attendance-history-table tbody");
      if (todayTable) todayTable.innerHTML = "";
      if (historyTable) historyTable.innerHTML = "";
      const byBand = (currentUser?.role === "Teacher" && teacherBand)
        ? records.filter(r => {
            const s = studentsCache.find(st => st.id === r.student_id);
            return classifyGradeLevel(s?.grade_level) === teacherBand;
          })
        : records;
      const today = todayStr();
      const todays = byBand.filter(r => r.attendance_date === today);
      const history = byBand.filter(r => r.attendance_date !== today).slice(0, 50);

      const renderRow = (r, targetTbody) => {
        const st = studentsCache.find(s => s.id === r.student_id);
        const studentName = st ? `${st.first_name} ${st.last_name}` : r.student_id;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${studentName}</td>
                        <td>${r.attendance_date}</td>
                        <td>
                          <select data-id="${r.id}" class="attn-status">
                            <option ${r.status==="Present"?"selected":""}>Present</option>
                            <option ${r.status==="Absent"?"selected":""}>Absent</option>
                            <option ${r.status==="Tardy"?"selected":""}>Tardy</option>
                          </select>
                        </td>
                        <td><button class="attn-save" data-id="${r.id}">Save</button></td>`;
        targetTbody.appendChild(tr);
      };

      todays.forEach(r => renderRow(r, todayTable));
      history.forEach(r => renderRow(r, historyTable));

      const wireSaves = (tbody) => {
        tbody.querySelectorAll(".attn-save").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const select = tbody.querySelector(`select[data-id="${id}"]`);
            const status = select?.value;
            try {
              await updateAttendanceStatus(id, status);
              await loadAttendanceTable();
            } catch (ex) {
              document.getElementById("attendance-error").textContent = ex.message;
            }
          });
        });
      };
      if (todayTable) wireSaves(todayTable);
      if (historyTable) wireSaves(historyTable);
    }

    async function buildAttendanceSheet() {
      const tbody = document.querySelector("#attendance-sheet-table tbody");
      if (!tbody) return;
      setTodayAttendanceDate();
      const date = document.getElementById("attendance-date")?.value || todayStr();
      const sectionId = Number(document.getElementById("attendance-section")?.value) || null;
      const subjectId = Number(document.getElementById("attendance-subject")?.value) || null;
      const students = studentsCache.filter(s => !sectionId || s.section_id === sectionId);
      if (!students.length) {
        tbody.innerHTML = `<tr><td colspan="2" style="text-align:center; color: var(--muted);">No students for this selection.</td></tr>`;
        return;
      }
      const qs = new URLSearchParams();
      qs.append("attendance_date", date);
      if (sectionId) qs.append("section_id", sectionId);
      if (subjectId) qs.append("subject_id", subjectId);
      let existing = [];
      try { existing = await fetchJSON(`/attendance?${qs.toString()}`); } catch (_) { existing = []; }
      const existingMap = new Map(existing.map(r => [r.student_id, r]));
      tbody.innerHTML = "";
      students.forEach(st => {
        const current = existingMap.get(st.id);
        const status = current?.status || "Present";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${st.first_name} ${st.last_name}</td>
                        <td>
                          <select data-student="${st.id}" class="attn-sheet-status">
                            <option ${status==="Present"?"selected":""}>Present</option>
                            <option ${status==="Absent"?"selected":""}>Absent</option>
                            <option ${status==="Tardy"?"selected":""}>Tardy</option>
                          </select>
                        </td>`;
        tbody.appendChild(tr);
      });
    }

    function renderAttendance(attendance) {
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      const data = [attendance.Present || 0, attendance.Absent || 0, attendance.Tardy || 0];
      if (attendanceChart) attendanceChart.destroy();
      attendanceChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Present", "Absent", "Tardy"],
          datasets: [{ 
              data, 
              backgroundColor: ["#10b981", "#ef4444", "#f59e0b"],
              borderWidth: 0
            }],
        },
        options: {
            plugins: {
                legend: { labels: { color: '#94a3b8' } }
            }
        }
      });
    }

    function renderGrades(averages) {
      const ctx = document.getElementById("gradesChart").getContext("2d");
      const labels = averages.map(a => a.subject);
      const data = averages.map(a => a.average.toFixed(2));
      if (gradesChart) gradesChart.destroy();
      gradesChart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Average %", data, backgroundColor: "#6366f1", borderRadius: 4 }] },
        options: { 
            scales: { 
                y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            },
            plugins: { legend: { display: false } }
        },
      });
    }

    async function renderTrendChart(studentId) {
      if (!studentId) return;
      const grades = await fetchJSON(`/grades?student_id=${studentId}`);
      const sorted = grades.sort((a,b) => new Date(a.recorded_on) - new Date(b.recorded_on));
      const labels = sorted.map(g => g.recorded_on);
      const data = sorted.map(g => g.grade_value);
      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Grade %", data, borderColor: "#6366f1", backgroundColor: "rgba(99, 102, 241, 0.2)", fill: true, tension: 0.3 }] },
        options: { 
            scales: { 
                y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            },
            plugins: { legend: { display: false } }
        },
      });
    }

    function updateCommsNotifications(filtered) {
      if (!currentUser || currentUser.role !== "Teacher") {
        document.getElementById("comms-badge").style.display = "none";
        const alert = document.getElementById("comms-alert");
        if (alert) alert.style.display = "none";
        return;
      }
      const badge = document.getElementById("comms-badge");
      const alert = document.getElementById("comms-alert");
      const lastSeen = localStorage.getItem("spms_comms_seen_ts") || "1970-01-01T00:00:00Z";
      const unseen = filtered.filter(c => new Date(c.created_at) > new Date(lastSeen));
      if (unseen.length > 0) {
        badge.textContent = unseen.length;
        badge.style.display = "inline-block";
        if (alert) alert.style.display = "block";
      } else {
        badge.style.display = "none";
        if (alert) alert.style.display = "none";
      }
    }

    async function loadComms(markSeen = false) {
      const comms = await fetchJSON("/communications");
      const filtered = (currentUser && currentUser.role === "Teacher")
        ? comms.filter(c => {
            const r = (c.recipient || "").toLowerCase();
            const name = (currentUser.full_name || currentUser.username || "").toLowerCase();
            return r && r === name;
          }).sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
        : comms.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      const tbody = document.querySelector("#comm-table tbody");
      tbody.innerHTML = "";
      filtered.slice(0, 25).forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.subject}</td><td>${c.sender_name} <span style="font-size:11px; opacity:0.7;">(${c.sender_role})</span></td><td>${c.recipient || "-"}</td><td>${c.student_name || "-"}</td><td>${c.created_at}</td>`;
        tbody.appendChild(tr);
      });

      // notifications
      if (filtered.length > 0) {
        const latestTs = filtered[0].created_at;
        if (markSeen) {
          localStorage.setItem("spms_comms_seen_ts", latestTs);
        }
      }
      updateCommsNotifications(filtered);
    }

    async function loadTeachers() {
      teachersCache = await fetchJSON("/users?role=Teacher");
      const teacherList = document.getElementById("teacher-options");
      if (teacherList) {
        teacherList.innerHTML = "";
        teachersCache.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.full_name || t.username;
          teacherList.appendChild(opt);
        });
      }
    }

    function renderSuggestions(list, targetEl, onPick) {
      targetEl.innerHTML = "";
      list.slice(0, 5).forEach(item => {
        const div = document.createElement("div");
        div.style.padding = "6px 10px";
        div.style.cursor = "pointer";
        div.textContent = item.label;
        div.onclick = () => onPick(item);
        targetEl.appendChild(div);
      });
    }

    function attachSuggestField(inputEl, sugEl, lookupFn, onPick) {
      let hideTimeout;
      const hide = () => { sugEl.innerHTML = ""; };
      inputEl.addEventListener("input", () => {
        const q = inputEl.value.toLowerCase().trim();
        if (!q) { hide(); return; }
        const matches = lookupFn(q);
        renderSuggestions(matches, sugEl, (item) => {
          onPick(item);
          hide();
        });
      });
      inputEl.addEventListener("focus", () => {
        const q = inputEl.value.toLowerCase().trim();
        if (!q) { hide(); return; }
        const matches = lookupFn(q);
        renderSuggestions(matches, sugEl, (item) => {
          onPick(item);
          hide();
        });
      });
      inputEl.addEventListener("blur", () => {
        hideTimeout = setTimeout(hide, 120);
      });
      sugEl.addEventListener("mouseenter", () => clearTimeout(hideTimeout));
      sugEl.addEventListener("mouseleave", () => hideTimeout = setTimeout(hide, 80));
    }

    async function loadAdviserInsights() {
      const data = await fetchJSON("/adviser-insights");
      const low = document.getElementById("admin-low-grades");
      const att = document.getElementById("admin-att-risk");
      low.innerHTML = data.low_grades.length
        ? data.low_grades.map(l => `<tr><td>${l.student_name}</td><td>${l.average.toFixed(2)}</td></tr>`).join("")
        : "<tr><td colspan='2'>No data</td></tr>";
      att.innerHTML = data.attendance_risk.length
        ? data.attendance_risk.map(a => `<tr><td>${a.student_name}</td><td>${a.present_rate}%</td><td>${a.total_logs}</td></tr>`).join("")
        : "<tr><td colspan='3'>No data</td></tr>";
    }

    async function loadUsers() {
      usersCache = await fetchJSON("/users");
      const pendingTeachers = usersCache.filter(u => u.role === "Teacher" && !u.approved);
      const badge = document.getElementById("admin-pending-badge");
      if (badge) {
        if (pendingTeachers.length > 0) {
          badge.textContent = pendingTeachers.length;
          badge.style.display = "inline-block";
        } else {
          badge.style.display = "none";
        }
      }
      const tbody = document.querySelector("#users-table tbody");
      tbody.innerHTML = "";
      usersCache.forEach(u => {
        const tr = document.createElement("tr");
        const status = u.approved ? "Approved" : "Pending";
        tr.innerHTML = `<td>${u.username}</td><td>${u.full_name}</td><td>${u.role}</td><td>${status}</td>
                        <td style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                          <select data-id="${u.id}" class="user-role-update" style="padding: 4px 8px; height: auto;">
                            <option ${u.role==="Admin"?"selected":""}>Admin</option>
                            <option ${u.role==="Teacher"?"selected":""}>Teacher</option>
                            <option ${u.role==="Parent"?"selected":""}>Parent</option>
                          </select>
                          ${u.role==="Teacher" ? `<select data-id="${u.id}" class="user-band-update" style="padding: 4px 8px; height: auto;">
                              <option value="">Band</option>
                              <option value="JHS" ${u.teacher_band==="JHS"?"selected":""}>JHS</option>
                              <option value="SHS" ${u.teacher_band==="SHS"?"selected":""}>SHS</option>
                            </select>` : ""}
                          ${!u.approved && u.role==="Teacher" ? `<button class="user-approve" data-id="${u.id}" style="padding:6px 10px; background:rgba(16,185,129,0.15); color:#34d399; border:1px solid rgba(16,185,129,0.2);">Approve</button>` : ""}
                          <button class="user-delete" data-id="${u.id}" style="padding:6px 10px; background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.2);">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll(".user-role-update").forEach(sel => {
        sel.onchange = async () => {
          try {
            await fetchJSON(`/users/${sel.dataset.id}`, { method: "PUT", body: JSON.stringify({ role: sel.value }) });
            showToast("User role updated", "success");
          } catch (ex) {
            showToast(ex.message, "error");
            await loadUsers();
          }
        };
      });
      document.querySelectorAll(".user-band-update").forEach(sel => {
        sel.onchange = async () => {
          try {
            await fetchJSON(`/users/${sel.dataset.id}`, { method: "PUT", body: JSON.stringify({ teacher_band: sel.value || null }) });
            await loadUsers();
            showToast("Teacher band updated", "success");
          } catch (ex) {
            showToast(ex.message, "error");
            await loadUsers();
          }
        };
      });
      document.querySelectorAll(".user-approve").forEach(btn => {
        btn.onclick = async () => {
          try {
            await fetchJSON(`/users/${btn.dataset.id}`, { method: "PUT", body: JSON.stringify({ approved: true }) });
            await loadUsers();
            showToast("User approved", "success");
          } catch (ex) {
            showToast(ex.message, "error");
          }
        };
      });
      document.querySelectorAll(".user-delete").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this user?")) return;
          try {
            await fetchJSON(`/users/${btn.dataset.id}`, { method: "DELETE" });
            await loadUsers();
            showToast("User deleted", "success");
          } catch (ex) {
            showToast(ex.message, "error");
          }
        };
      });
    }

    function wireForms(user) {
      document.getElementById("student-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("student-error");
        err.textContent = "";
        err.style.display = "none";
        const last5 = document.getElementById("student-number").value.trim();
        if (!/^\d{5}$/.test(last5)) { err.textContent = "Enter last 5 digits (numbers only)."; err.style.display = "block"; return; }
        const formattedNumber = `STU-${last5}`;
        const sectionId = Number(document.getElementById("student-section").value) || null;
        const payload = {
          student_number: formattedNumber,
          first_name: document.getElementById("student-first").value.trim(),
          middle_name: document.getElementById("student-middle").value.trim() || undefined,
          last_name: document.getElementById("student-last").value.trim(),
          date_of_birth: document.getElementById("student-dob").value || undefined,
          grade_level: document.getElementById("student-grade").value || undefined,
          section_id: sectionId || undefined,
        };
        try {
          await fetchJSON("/students", { method: "POST", body: JSON.stringify(payload), successMessage: "Student saved" });
          e.target.reset();
          await refreshAll();
        } catch (ex) { err.textContent = ex.message; err.style.display = "block"; }
      });

      const attSection = document.getElementById("attendance-section");
      const attSubject = document.getElementById("attendance-subject");
      if (attSection) attSection.onchange = buildAttendanceSheet;
      if (attSubject) attSubject.onchange = buildAttendanceSheet;
      const attSave = document.getElementById("attendance-save");
      if (attSave) {
        attSave.addEventListener("click", async () => {
        const err = document.getElementById("attendance-error");
          err.style.color = "#fca5a5";
        err.textContent = "";
          err.style.display = "none";
          setTodayAttendanceDate();
          const date = document.getElementById("attendance-date").value;
          const sectionId = Number(document.getElementById("attendance-section").value) || null;
          const subjectId = Number(document.getElementById("attendance-subject").value) || null;
          if (!date) { err.textContent = "Date missing."; err.style.display = "block"; return; }
          const rows = Array.from(document.querySelectorAll(".attn-sheet-status"));
          if (!rows.length) { err.textContent = "No students to save."; err.style.display = "block"; return; }
          const records = rows.map(sel => ({
            student_id: Number(sel.dataset.student),
            status: sel.value || "Present",
          }));
        try {
            await fetchJSON("/attendance/bulk", {
              method: "POST",
              body: JSON.stringify({
                attendance_date: date,
                section_id: sectionId,
                subject_id: subjectId,
                records,
              }),
              successMessage: "Attendance saved",
            });
            err.style.color = "#34d399";
            err.textContent = "Attendance sheet saved.";
            err.style.display = "block";
          await refreshAll();
          } catch (ex) { err.textContent = ex.message; err.style.display = "block"; }
      });
      }

      // Communications form
      const studentSearch = document.getElementById("comm-student-search");
      const studentSug = document.getElementById("comm-student-suggestions");
      const studentIdHidden = document.getElementById("comm-student-id");
      const teacherSearch = document.getElementById("comm-teacher-search");
      const teacherSug = document.getElementById("comm-teacher-suggestions");
      const teacherNameHidden = document.getElementById("comm-teacher-name");

      attachSuggestField(
        studentSearch,
        studentSug,
        (q) => studentsCache
          .filter(s => (`${s.first_name} ${s.last_name}`).toLowerCase().includes(q))
          .map(s => ({ id: s.id, label: `${s.first_name} ${s.last_name}` })),
        (item) => {
          studentSearch.value = item.label;
          studentIdHidden.value = item.id;
        }
      );

      attachSuggestField(
        teacherSearch,
        teacherSug,
        (q) => teachersCache
          .filter(t => (t.full_name || t.username).toLowerCase().includes(q))
          .map(t => ({ id: t.id, label: t.full_name || t.username })),
        (item) => {
          teacherSearch.value = item.label;
          teacherNameHidden.value = item.label;
        }
      );

      document.getElementById("comm-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("comm-error"); err.textContent = "";
        const payload = {
          student_id: studentIdHidden.value || undefined,
          sender_name: user.full_name || user.username,
          sender_role: user.role,
          recipient: teacherNameHidden.value || teacherSearch.value.trim() || undefined,
          subject: document.getElementById("comm-subject").value.trim(),
          message_body: document.getElementById("comm-body").value.trim(),
        };
        try {
          await fetchJSON("/communications", { method: "POST", body: JSON.stringify(payload), successMessage: "Message sent" });
          e.target.reset();
          studentIdHidden.value = "";
          teacherNameHidden.value = "";
          studentSearch.value = "";
          teacherSearch.value = "";
          await loadComms();
          await loadDashboard();
          localStorage.setItem("spms_comms_seen_ts", new Date().toISOString());
          updateCommsNotifications([]);
        } catch (ex) { err.textContent = ex.message; }
      });

      document.getElementById("user-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("user-error"); err.textContent = "";
        const payload = {
          username: document.getElementById("user-username").value.trim(),
          full_name: document.getElementById("user-fullname").value.trim(),
          role: document.getElementById("user-role").value,
          password: document.getElementById("user-password").value.trim(),
        teacher_band: document.getElementById("user-band").value || undefined,
        };
        if (!payload.role) { err.textContent = "Select a role"; return; }
        try {
          await fetchJSON("/users", { method: "POST", body: JSON.stringify(payload), successMessage: "User created" });
          e.target.reset();
          await loadUsers();
        } catch (ex) { err.textContent = ex.message; }
      });

      const subjectForm = document.getElementById("subject-form");
      if (subjectForm) {
        subjectForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const err = document.getElementById("subject-error"); err.textContent = "";
          const payload = {
            name: document.getElementById("sub-name").value.trim(),
            level_band: document.getElementById("sub-level").value,
            category: document.getElementById("sub-category").value,
            track: document.getElementById("sub-track").value || undefined,
            grade_min: document.getElementById("sub-grade-min").value ? Number(document.getElementById("sub-grade-min").value) : undefined,
            grade_max: document.getElementById("sub-grade-max").value ? Number(document.getElementById("sub-grade-max").value) : undefined,
            teacher_id: document.getElementById("sub-teacher").value ? Number(document.getElementById("sub-teacher").value) : undefined,
          };
          if (!payload.level_band || !payload.category) {
            err.textContent = "Select level band and category.";
            return;
          }
          try {
            if (editingSubjectId) {
              await fetchJSON(`/subjects/${editingSubjectId}`, { method: "PUT", body: JSON.stringify(payload), successMessage: "Subject updated" });
            } else {
              await fetchJSON("/subjects", { method: "POST", body: JSON.stringify(payload), successMessage: "Subject created" });
            }
            resetSubjectForm();
            await loadSubjects();
          } catch (ex) { err.textContent = ex.message; }
        });
        document.getElementById("sub-cancel").addEventListener("click", () => {
          resetSubjectForm();
        });
      }

      document.getElementById("trend-refresh").addEventListener("click", async () => {
        const studentId = document.getElementById("trend-student").value;
        await renderTrendChart(studentId);
      });

      const gradeStudent = document.getElementById("grade-student");
      if (gradeStudent) {
        gradeStudent.addEventListener("change", () => populateGradeSubjects());
      }
      const gradeSubjectSelect = document.getElementById("grade-subject");
      if (gradeSubjectSelect) {
        gradeSubjectSelect.addEventListener("change", () => computeGradeTotal());
      }
      const gradeSectionSelect = document.getElementById("grade-section");
      if (gradeSectionSelect) {
        gradeSectionSelect.addEventListener("change", () => {
          loadStudents(); // repopulate student dropdown scoped to section
          loadGradesTable();
        });
      }

      const sheetSubject = document.getElementById("sheet-subject");
      if (sheetSubject) {
        sheetSubject.addEventListener("change", () => {
          gradeSheetSubject = sheetSubject.value;
          rebuildGradeSheetFromData();
        });
        document.getElementById("sheet-add-activity").addEventListener("click", () => addGradeSheetActivity());
        document.getElementById("sheet-save").addEventListener("click", () => saveGradeSheetBulk());
      }
      const sheetSection = document.getElementById("sheet-section");
      if (sheetSection) {
        sheetSection.addEventListener("change", () => {
          gradeSheetSectionId = Number(sheetSection.value) || null;
          loadSubjects(); // refresh subject list with section grade filter
          rebuildGradeSheetFromData();
        });
      }

      const sectionForm = document.getElementById("section-form");
      if (sectionForm) {
        sectionForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const err = document.getElementById("section-error");
          err.textContent = "";
          const rawName = document.getElementById("section-name").value.trim();
          const gradeVal = document.getElementById("section-grade").value.trim();
          const combinedName = rawName ? (gradeVal ? `Grade ${gradeVal} - ${rawName}` : rawName) : "";
          const payload = {
            name: combinedName,
            level_band: document.getElementById("section-band").value || null,
            grade_level: gradeVal || null,
            track: document.getElementById("section-track").value || null,
            adviser_id: Number(document.getElementById("section-adviser").value) || null,
          };
          if (!payload.name) { err.textContent = "Name is required."; return; }
          try {
            await fetchJSON("/sections", { method: "POST", body: JSON.stringify(payload), successMessage: "Section created" });
            sectionForm.reset();
            await refreshAll();
          } catch (ex) { err.textContent = ex.message; }
        });
      }

      const assignSectionSel = document.getElementById("assign-section");
      if (assignSectionSel) {
        assignSectionSel.addEventListener("change", () => {
          updateAssignStudentOptions();
          updateSectionRoster();
          syncScheduleSectionSelect();
        });
      }
      const assignBtn = document.getElementById("assign-btn");
      if (assignBtn) {
        assignBtn.addEventListener("click", () => assignStudentToSection());
      }

      const reportBtn = document.getElementById("grade-report-btn");
      if (reportBtn) {
        reportBtn.addEventListener("click", () => downloadStudentReport());
      }
      const schedGen = document.getElementById("schedule-generate");
      if (schedGen) {
        schedGen.addEventListener("click", () => generateSectionSchedule());
      }
      const schedPrint = document.getElementById("schedule-print");
      if (schedPrint) {
        schedPrint.addEventListener("click", () => printSectionSchedule());
      }
      const schedPdf = document.getElementById("schedule-pdf");
      if (schedPdf) {
        schedPdf.addEventListener("click", () => downloadSectionSchedulePdf());
      }
      const roomForm = document.getElementById("room-form");
      if (roomForm) {
        roomForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          await createRoom();
        });
      }
      const gradeRefresh = document.getElementById("grade-refresh");
      if (gradeRefresh) {
        gradeRefresh.addEventListener("click", () => loadGradesTable());
      }

      const sheetBand = document.getElementById("sheet-band");
      if (sheetBand) {
        sheetBand.addEventListener("change", async () => {
          adminBandFilter = sheetBand.value || null;
          await refreshAll();
        });
      }
    }

    async function refreshUserBand() {
      if (!currentUser || currentUser.role !== "Teacher") return;
      try {
        const data = await fetchJSON(`/users?user_id=${currentUser.id}`);
        if (Array.isArray(data) && data.length === 1) {
          const u = data[0];
          currentUser.teacher_band = u.teacher_band;
          teacherBand = u.teacher_band || teacherBand;
          if (teacherBand) localStorage.setItem("spms_teacher_band", teacherBand);
        }
      } catch (ex) {
        console.warn("Could not refresh user band", ex);
      }
    }

    async function refreshAll() {
      setTodayAttendanceDate();
      await refreshUserBand();
      await loadUsers();
      await Promise.all([
        loadDashboard(),
        loadStudents(),
        loadSubjects(),
        loadSections(),
        loadGradesTable(),
        loadAttendanceTable(),
        loadTeachers(),
        loadComms(),
        loadAdviserInsights(),
        loadRooms(),
      ]);
      await buildAttendanceSheet();
      populateGradeSubjects();
      computeGradeTotal();
      rebuildGradeSheetFromData();
      renderNextClassForTeacher();
      updateScheduleSectionSelect();
      await loadSectionSchedule();
      await loadTeacherSchedule();
    }

    function resetSubjectForm() {
      editingSubjectId = null;
      document.getElementById("sub-id").value = "";
      document.getElementById("sub-name").value = "";
      document.getElementById("sub-level").value = "";
      document.getElementById("sub-category").value = "";
      document.getElementById("sub-track").value = "";
      document.getElementById("sub-grade-min").value = "";
      document.getElementById("sub-grade-max").value = "";
      document.getElementById("sub-teacher").value = "";
      document.getElementById("sub-submit").textContent = "Add Subject";
      document.getElementById("sub-cancel").style.display = "none";
      const err = document.getElementById("subject-error");
      if (err) err.textContent = "";
    }

    function applyRoleVisibility(role) {
      const tabButtons = document.querySelectorAll("nav button[data-tab]");
      const hiddenTabs = [];
      // Default: Admin sees all, Teacher sees all but admin/subjects; Parent read-only.
      if (role === "Parent") {
        hiddenTabs.push("students", "logs", "admin"); // no CRUD
        hiddenTabs.push("subjects");
        hiddenTabs.push("attendance");
        // disable forms
        document.querySelectorAll("form button").forEach(b => {
          if (!b.closest("#comm-form")) b.disabled = true;
        });
      }
      if (role === "Teacher") {
        // hide admin + subjects + sections tab for regular teachers
        hiddenTabs.push("admin");
        hiddenTabs.push("subjects");
        hiddenTabs.push("sections");
      }
      const sheetBand = document.getElementById("sheet-band");
      if (sheetBand) {
        sheetBand.style.display = role === "Admin" ? "block" : "none";
        if (role !== "Admin") {
          sheetBand.value = "";
          adminBandFilter = null;
        }
      }
      tabButtons.forEach(btn => {
        const tab = btn.dataset.tab;
        if (hiddenTabs.includes(tab)) {
          btn.style.display = "none";
          if (btn.classList.contains("active")) switchTab("overview");
        }
      });
      // Also hide tab sections
      hiddenTabs.forEach(tab => {
        const section = document.getElementById(`tab-${tab}`);
        if (section) section.style.display = "none";
      });
      const adminPanel = document.getElementById("admin-students-panel");
      if (adminPanel) adminPanel.style.display = role === "Admin" ? "block" : "none";
      // For parents, make read-only tables still visible
      if (role === "Parent") {
        // allow switching only overview, trends, comms
        tabButtons.forEach(btn => {
          if (!["overview", "trends", "comms"].includes(btn.dataset.tab)) {
            btn.style.display = "none";
          }
        });
      }
    }

    function ensureAccessibilityLabels() {
      document.querySelectorAll("select").forEach(sel => {
        if (!sel.getAttribute("aria-label") && !sel.getAttribute("title")) {
          const label = sel.getAttribute("placeholder") || sel.getAttribute("name") || sel.id || "Select";
          sel.setAttribute("aria-label", label);
          sel.setAttribute("title", label);
        }
      });
      document.querySelectorAll("button").forEach(btn => {
        const hasText = (btn.textContent || "").trim().length > 0;
        if (!hasText && !btn.getAttribute("aria-label")) {
          const label = btn.getAttribute("title") || btn.dataset.label || btn.dataset.action || btn.id || "Button";
          btn.setAttribute("aria-label", label);
        }
        if (!btn.getAttribute("title")) {
          const label = btn.getAttribute("aria-label") || (hasText ? btn.textContent.trim() : "");
          if (label) btn.setAttribute("title", label);
        }
      });
    }

    function syncScheduleSectionSelect() {
      const assignSel = document.getElementById("assign-section");
      const schedSel = document.getElementById("schedule-section");
      if (!assignSel || !schedSel) return;
      const val = assignSel.value;
      if (val) schedSel.value = val;
    }

    function dayName(n) {
      return ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][n] || n;
    }

    function formatTime12h(t) {
      if (!t || typeof t !== "string") return t || "";
      const [hStr, mStr] = t.split(":");
      let h = parseInt(hStr, 10);
      const m = mStr || "00";
      if (Number.isNaN(h)) return t;
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12;
      if (h === 0) h = 12;
      return `${h}:${m} ${ampm}`;
    }

    async function loadSectionSchedule() {
      const secId = Number(document.getElementById("schedule-section")?.value || document.getElementById("assign-section")?.value);
      const body = document.getElementById("section-schedule-body");
      const status = document.getElementById("schedule-status");
      if (!body) return;
      body.innerHTML = "";
      if (!secId) {
        body.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--muted);">Select a section.</td></tr>`;
        return;
      }
      try {
        const rows = await fetchJSON(`/schedule?section_id=${secId}`);
        if (!rows.length) {
          body.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--muted);">No schedule yet.</td></tr>`;
          status.textContent = "";
          return;
        }
        rows.sort((a,b) => (a.day_of_week - b.day_of_week) || (a.start_time.localeCompare(b.start_time)));
        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${dayName(r.day_of_week)}</td>
                          <td>${formatTime12h(r.start_time)} - ${formatTime12h(r.end_time)}</td>
                          <td>${r.subject_name || "-"}</td>
                          <td>${r.teacher_name || "-"}</td>
                          <td>${r.room_name || "-"}</td>`;
          body.appendChild(tr);
        });
        status.textContent = "";
      } catch (ex) {
        if (status) status.textContent = ex.message;
      }
    }

    async function generateSectionSchedule() {
      const secId = Number(document.getElementById("schedule-section")?.value || document.getElementById("assign-section")?.value);
      const status = document.getElementById("schedule-status");
      const allowSat = document.getElementById("schedule-allow-sat")?.checked || false;
      if (!secId) {
        if (status) status.textContent = "Select a section.";
        return;
      }
      try {
        status.textContent = "Generating...";
        const res = await fetchJSON("/schedule/auto-generate", {
          method: "POST",
          body: JSON.stringify({ section_id: secId, allow_saturday: allowSat })
        });
        status.textContent = `Created ${res.created.length} blocks${res.failed.length ? `, failed ${res.failed.length}` : ""}`;
        showToast("Schedule generated", "success");
        const schedSel = document.getElementById("schedule-section");
        if (schedSel) schedSel.value = String(secId);
        await loadSectionSchedule();
      } catch (ex) {
        if (status) status.textContent = ex.message;
      }
    }

    function printSectionSchedule() {
      const secSel = document.getElementById("schedule-section");
      const secId = Number(secSel?.value || 0);
      if (!secId) return;
      fetchJSON(`/schedule?section_id=${secId}`)
        .then(rows => {
          if (!rows.length) {
            showToast("No schedule for this section.", "info");
            return;
          }
          const title = secSel && secSel.value ? `Schedule - ${secSel.options[secSel.selectedIndex].text}` : "Section Schedule";
          renderScheduleToWindow(rows, title);
        })
        .catch(ex => showToast(ex.message || "Failed to load schedule.", "error"));
    }

    function downloadSectionSchedulePdf() {
      const secSel = document.getElementById("schedule-section");
      const secId = Number(secSel?.value || 0);
      if (!secId) {
        showToast("Select a section.", "error");
        return;
      }
      const url = `${API_BASE}/schedule/pdf?section_id=${secId}`;
      fetch(url, { headers: buildAuthHeaders() })
        .then(res => {
          if (!res.ok) throw new Error("Failed to download PDF");
          return res.blob();
        })
        .then(blob => {
          const dl = document.createElement("a");
          dl.href = URL.createObjectURL(blob);
          dl.download = "";
          document.body.appendChild(dl);
          dl.click();
          dl.remove();
        })
        .catch(err => showToast(err.message || "Download failed", "error"));
    }

    function renderScheduleToWindow(rows, title) {
      const win = window.open("", "_blank");
      const grouped = {};
      rows.forEach(r => {
        grouped[r.day_of_week] = grouped[r.day_of_week] || [];
        grouped[r.day_of_week].push(r);
      });
      Object.values(grouped).forEach(list => list.sort((a,b) => a.start_time.localeCompare(b.start_time)));
      let html = `<h2>${title}</h2><table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse; width:100%;">`;
      html += `<thead><tr><th>Day</th><th>Time</th><th>Section</th><th>Subject</th><th>Teacher</th><th>Room</th></tr></thead><tbody>`;
      rows
        .sort((a,b) => (a.day_of_week - b.day_of_week) || a.start_time.localeCompare(b.start_time))
        .forEach(r => {
          html += `<tr><td>${dayName(r.day_of_week)}</td><td>${formatTime12h(r.start_time)} - ${formatTime12h(r.end_time)}</td><td>${r.section_name || "-"}</td><td>${r.subject_name || "-"}</td><td>${r.teacher_name || "-"}</td><td>${r.room_name || "-"}</td></tr>`;
        });
      html += `</tbody></table>`;
      win.document.write(`<html><head><title>${title}</title></head><body>${html}</body></html>`);
      win.document.close();
      win.focus();
      win.print();
    }

    async function downloadStudentSchedule(studentId) {
      const st = studentsCache.find(s => s.id === studentId);
      if (!st || !st.section_id) {
        showToast("No section for this student.", "error");
        return;
      }
      try {
        const rows = await fetchJSON(`/schedule?section_id=${st.section_id}`);
        if (!rows.length) {
          showToast("No schedule for this section.", "info");
          return;
        }
        renderScheduleToWindow(rows, `Schedule - ${st.first_name} ${st.last_name}`);
      } catch (ex) {
        showToast(ex.message || "Failed to load schedule.", "error");
      }
    }

    async function loadTeacherSchedule() {
      const card = document.getElementById("teacher-schedule-card");
      if (!currentUser || currentUser.role !== "Teacher") {
        if (card) card.style.display = "none";
        return;
      }
      const tbody = document.getElementById("teacher-schedule-body");
      if (card) card.style.display = "block";
      if (!tbody) return;
      tbody.innerHTML = "";
      try {
        const rows = await fetchJSON(`/schedule?teacher_id=${currentUser.id}`);
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--muted);">No schedule assigned.</td></tr>`;
          return;
        }
        rows.sort((a,b) => (a.day_of_week - b.day_of_week) || (a.start_time.localeCompare(b.start_time)));
        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${dayName(r.day_of_week)}</td>
                          <td>${formatTime12h(r.start_time)} - ${formatTime12h(r.end_time)}</td>
                          <td>${r.section_name || "-"}</td>
                          <td>${r.subject_name || "-"}</td>
                          <td>${r.room_name || "-"}</td>`;
          tbody.appendChild(tr);
        });
        // add print button if not present
        if (!document.getElementById("teacher-schedule-print")) {
          const btn = document.createElement("button");
          btn.id = "teacher-schedule-print";
          btn.textContent = "Print";
          btn.className = "btn-secondary";
          btn.style.marginTop = "8px";
          card.appendChild(btn);
          btn.addEventListener("click", () => renderScheduleToWindow(rows, "My Schedule"));
        }
        if (!document.getElementById("teacher-schedule-pdf")) {
          const btn2 = document.createElement("button");
          btn2.id = "teacher-schedule-pdf";
          btn2.textContent = "Download PDF";
          btn2.className = "btn-secondary";
          btn2.style.marginTop = "8px";
          btn2.style.marginLeft = "8px";
          card.appendChild(btn2);
          btn2.addEventListener("click", () => {
            const url = `${API_BASE}/schedule/pdf?teacher_id=${currentUser.id}`;
            fetch(url, { headers: buildAuthHeaders() })
              .then(res => {
                if (!res.ok) throw new Error("Failed to download PDF");
                return res.blob();
              })
              .then(blob => {
                const dl = document.createElement("a");
                dl.href = URL.createObjectURL(blob);
                dl.download = "";
                document.body.appendChild(dl);
                dl.click();
                dl.remove();
              })
              .catch(err => showToast(err.message || "Download failed", "error"));
          });
        }
      } catch (ex) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--muted);">${ex.message}</td></tr>`;
      }
    }

    async function loadRooms() {
      const body = document.getElementById("room-table-body");
      const status = document.getElementById("room-status");
      if (!body) return;
      body.innerHTML = "";
      try {
        const rooms = await fetchJSON("/rooms");
        if (!rooms.length) {
          body.innerHTML = `<tr><td colspan="4" style="text-align:center; color: var(--muted);">No rooms yet.</td></tr>`;
          return;
        }
        rooms.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.name}</td><td>${r.building || "-"}</td><td>${r.level || "-"}</td><td><button class="room-delete" data-id="${r.id}">Delete</button></td>`;
          body.appendChild(tr);
        });
        body.querySelectorAll(".room-delete").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (!confirm("Delete this room?")) return;
            try {
              await fetchJSON(`/rooms/${btn.dataset.id}`, { method: "DELETE", successMessage: "Room deleted" });
              await loadRooms();
            } catch (ex) {
              if (status) status.textContent = ex.message;
            }
          });
        });
        if (status) status.textContent = "";
      } catch (ex) {
        if (status) status.textContent = ex.message;
      }
    }

    async function createRoom() {
      const name = document.getElementById("room-name").value.trim();
      const building = document.getElementById("room-building").value.trim();
      const level = document.getElementById("room-level").value.trim();
      const status = document.getElementById("room-status");
      if (!name) {
        if (status) status.textContent = "Room name required.";
        return;
      }
      try {
        await fetchJSON("/rooms", {
          method: "POST",
          body: JSON.stringify({ name, building, level }),
          successMessage: "Room added"
        });
        document.getElementById("room-form").reset();
        if (status) status.textContent = "Room added.";
        await loadRooms();
      } catch (ex) {
        if (status) status.textContent = ex.message;
      }
    }
    document.addEventListener("DOMContentLoaded", async () => {
      const user = ensureUser();
      if (!user) return;

      updateLiveClock();
      setInterval(updateLiveClock, 1000);
      ensureAccessibilityLabels();
      setTodayAttendanceDate();
      applyRoleVisibility(user.role);

      // Attach animated background to login-like shells if present
      const loginTargets = ["login-container", "login-card", "login", "login-page", "auth-shell"];
      const targetId = loginTargets.find(id => document.getElementById(id));
      if (targetId) {
        mountBackgroundPaths(targetId, "Background Paths");
      }

      document.querySelectorAll("nav button[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });

      wireForms(user);
      await refreshAll();

      // Poll for new comms for teachers
      if (user.role === "Teacher") {
        setInterval(() => loadComms(false), 30000);
      }
    });
  </script>
</body>
</html>