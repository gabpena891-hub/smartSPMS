<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Performance | Dashboard</title>
  <script>
    tailwind = { config: { corePlugins: { preflight: false } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --sidebar: #1e293b;
      --card: #1e293b;
      --border: rgba(255, 255, 255, 0.08);
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --danger: #ef4444;
      --success: #10b981;
    }
    * { box-sizing: border-box; outline: none; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* Sidebar Styling */
    aside {
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      padding: 32px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .brand { 
      font-size: 20px; 
      font-weight: 700; 
      letter-spacing: -0.025em; 
      color: white; 
      margin-bottom: 20px;
      padding-left: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand::before {
      content: '';
      display: block;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--accent);
    }
    nav { display: flex; flex-direction: column; gap: 4px; }
    nav button {
      width: 100%;
      color: var(--muted);
      background: transparent;
      border: none;
      text-align: left;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    nav button:hover {
      background: rgba(255,255,255,0.03);
      color: white;
    }
    nav button.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    nav button[onclick="logout()"] {
      margin-top: auto;
      color: #fca5a5;
    }
    nav button[onclick="logout()"]:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
    }

    /* Main Content */
    main { 
      padding: 40px; 
      max-width: 1600px;
      width: 100%;
      margin: 0 auto;
    }
    
    header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 32px; 
    }
    #user-name {
      font-size: 24px;
      margin-top: 4px;
      color: white;
    }

    /* Cards */
    .cards { display: grid; gap: 24px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-bottom: 32px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      border-color: rgba(255,255,255,0.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .card h3 { 
      margin: 0 0 12px; 
      font-size: 13px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      color: var(--muted); 
      font-weight: 600;
    }
    .card .value { font-size: 32px; font-weight: 700; color: white; letter-spacing: -0.03em; }

    /* Grid Layouts */
    .grid { display: grid; gap: 24px; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-bottom: 32px; }
    
    /* Charts */
    canvas { 
      background: rgba(15, 23, 42, 0.5); 
      border-radius: 12px; 
      padding: 16px; 
      width: 100% !important;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      margin-top: 16px;
    }
    th, td { 
      padding: 16px 20px; 
      text-align: left; 
      font-size: 14px; 
      border-bottom: 1px solid var(--border); 
    }
    th { 
      background: rgba(255,255,255,0.02); 
      font-weight: 600; 
      color: var(--muted); 
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    
    /* Forms */
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
      background: rgba(30, 41, 59, 0.5);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    input, select, textarea {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: white;
      font-size: 14px;
      font-family: inherit;
      transition: border 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    textarea { min-height: 100px; resize: vertical; }
    
    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      padding: 12px 20px;
      font-size: 14px;
      transition: all 0.2s;
      font-family: inherit;
    }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    
    /* Specific Button Styles */
    .delete-student {
      background: rgba(239, 68, 68, 0.15) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
      box-shadow: none !important;
    }
    .delete-student:hover {
      background: rgba(239, 68, 68, 0.25) !important;
    }

    #trend-refresh {
        width: auto;
        padding: 0 24px;
    }

    /* Utilities */
    .error { color: #fca5a5; margin-top: 8px; font-size: 13px; font-weight: 500; }
    .tab { display: none; animation: fadeIn 0.3s ease; }
    .tab.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .section-title { margin: 32px 0 16px; color: white; font-size: 18px; font-weight: 600; }
    .flex { display: flex; gap: 16px; align-items: center; }
    
    .pill-input { border-radius: 50px; }
    .suggestions {
      margin-top: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-height: 200px;
      overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .suggestions div {
      padding: 10px 16px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .suggestions div:hover { background: rgba(99, 102, 241, 0.1); color: var(--accent); }

     .badge {
       display: inline-block;
       min-width: 20px;
       padding: 2px 8px;
       border-radius: 999px;
       background: #f97316;
       color: white;
       font-size: 11px;
       font-weight: 700;
       vertical-align: middle;
       margin-left: 8px;
     }

    /* Responsive */
    @media (max-width: 900px) {
      body { grid-template-columns: 1fr; }
      aside { 
        height: auto; 
        flex-direction: row; 
        overflow-x: auto; 
        position: relative; 
        padding: 16px;
        align-items: center;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .brand { margin-bottom: 0; margin-right: 20px; font-size: 16px; }
      nav { flex-direction: row; }
      nav button { white-space: nowrap; padding: 8px 12px; font-size: 13px; }
      nav button[onclick="logout()"] { margin-left: auto; margin-top: 0; }
      main { padding: 20px; }
    }
  </style>
</head>
<body>
  <aside>
    <div class="brand" style="display:flex; align-items:center; gap:12px;">
      <svg width="40" height="40" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 1L28.99 8.5V23.5L16 31L3.01 23.5V8.5L16 1Z" 
              fill="rgba(99, 102, 241, 0.2)" 
              stroke="#6366f1" 
              stroke-width="2" 
              stroke-linejoin="round"/>
        <path d="M8 16H12L15 11L19 21L22 16H26" 
              stroke="#f8fafc" 
              stroke-width="2" 
              stroke-linecap="round" 
              stroke-linejoin="round"/>
      </svg>
      <span>SPMS Dashboard</span>
    </div>
    <nav>
      <button class="active" data-tab="overview">Overview</button>
      <button data-tab="students">Students</button>
      <button data-tab="logs">Grades</button>
      <button data-tab="grade-sheet">Grade Sheet</button>
      <button data-tab="attendance">Attendance</button>
      <button data-tab="trends">Trends</button>
      <button data-tab="comms">Communications <span id="comms-badge" class="badge" style="display:none;">0</span></button>
      <button data-tab="subjects">Subjects</button>
      <button data-tab="admin">Administration <span id="admin-pending-badge" class="badge" style="display:none;">0</span></button>
      <button onclick="logout()">Logout</button>
    </nav>
  </aside>
  <main>
    <header>
      <div>
        <div style="color: var(--muted); font-size: 13px; font-weight: 500;">Welcome back</div>
        <div id="user-name" style="font-weight: 700;">Loading...</div>
      </div>
    </header>

    <section class="tab active" id="tab-overview">
      <div class="cards">
        <div class="card"><h3>Students</h3><div class="value" id="total-students">-</div></div>
        <div class="card"><h3>Grades Recorded</h3><div class="value" id="total-grades">-</div></div>
        <div class="card"><h3>Behavior Reports</h3><div class="value" id="total-behaviors">-</div></div>
        <div class="card"><h3>Communications</h3><div class="value" id="total-comms">-</div></div>
      </div>
      <div class="grid">
        <div class="card">
          <h3 style="margin-bottom: 20px;">Attendance Rates</h3>
          <canvas id="attendanceChart" height="240"></canvas>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 20px;">Average Grades per Subject</h3>
          <canvas id="gradesChart" height="240"></canvas>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-students">
      <h3 class="section-title" style="margin-top:0;">Manage Students</h3>
      <div id="student-error" class="error"></div>
      <form id="student-form">
        <input id="student-number" placeholder="Last 5 digits (e.g., 01234)" maxlength="5" pattern="[0-9]{5}" inputmode="numeric" title="Enter exactly 5 digits" required />
        <input id="student-first" placeholder="First name" required />
        <input id="student-middle" placeholder="Middle initial" maxlength="1" />
        <input id="student-last" placeholder="Last name" required />
        <input id="student-dob" type="date" />
        <input id="student-grade" placeholder="Grade level" />
        <input id="student-homeroom" placeholder="Homeroom teacher" list="teacher-options" />
        <button type="submit">Add Student</button>
      </form>
      <datalist id="teacher-options"></datalist>
      <p class="section-title">Directory</p>
        <table id="students-table">
          <thead><tr><th>Student #</th><th>Name</th><th>Grade</th><th>Homeroom</th><th>Birthdate (DOB)</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab" id="tab-logs">
      <div class="grid">
        <div class="card">
          <h3>Final Grades</h3>
          <div id="grade-error" class="error"></div>
          <div style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px;">
            <select id="grade-student" style="min-width:180px;"></select>
            <select id="grade-subject" style="min-width:200px;">
              <option value="">All subjects</option>
            </select>
            <button id="grade-refresh" type="button" style="background: var(--accent); border:none; padding:10px 16px; border-radius:10px; color:white;">Refresh</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
            <select id="report-student" style="min-width:180px;"></select>
            <button id="grade-report-btn" type="button">Download Student PDF</button>
          </div>
          <div id="grade-status" style="font-size:12px; color: var(--muted); margin-bottom:8px;"></div>
          <table id="grades-table">
            <thead><tr><th>Student</th><th>Subject</th><th>WW Avg</th><th>PT Avg</th><th>QA Avg</th><th>Final %</th><th>Entries</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-attendance">
      <div class="grid">
        <div class="card">
          <h3>Record Attendance</h3>
          <div id="attendance-error" class="error"></div>
          <form id="attendance-form" style="background: transparent; border: none; padding: 0; grid-template-columns: 1fr;">
            <select id="attendance-student" required></select>
            <input id="attendance-date" type="date" required />
            <select id="attendance-status" required>
              <option value="">Select Status</option>
              <option>Present</option><option>Absent</option><option>Tardy</option>
            </select>
            <button type="submit">Submit Attendance</button>
          </form>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h3>Recent Attendance</h3>
          <table id="attendance-table">
            <thead><tr><th>Student</th><th>Date</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-trends">
      <div class="card">
          <div class="flex" style="margin-bottom: 20px;">
            <select id="trend-student" style="max-width: 300px;"></select>
            <button id="trend-refresh">Refresh Trends</button>
          </div>
          <h3>Grade Trend (by assessment date)</h3>
          <canvas id="trendChart" height="120" style="max-height: 400px;"></canvas>
      </div>
    </section>

    <section class="tab" id="tab-grade-sheet">
      <h3 class="section-title" style="margin-top:0;">Grade Sheet (Class Record)</h3>
      <div class="card">
        <div id="sheet-error" class="error"></div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:12px;">
          <select id="sheet-band" style="display:none;">
            <option value="">All (Admin)</option>
            <option value="JHS">JHS</option>
            <option value="SHS">SHS</option>
          </select>
          <select id="sheet-subject">
            <option value="">Select subject</option>
          </select>
          <button id="sheet-add-activity" type="button" style="background: rgba(99,102,241,0.2); border:1px solid rgba(99,102,241,0.4);">Add Column</button>
          <button id="sheet-save" type="button" style="background: var(--accent); border:none;">Save Sheet</button>
        </div>
        <div id="sheet-weights" style="font-size:12px; color: var(--muted); margin-bottom: 8px;">Weights: -</div>
        <div style="max-height: 420px; overflow: auto; border: 1px solid var(--border); border-radius: 12px;">
          <table id="sheet-table">
            <thead><tr id="sheet-header-row"><th>Student</th><th>Final</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="sheet-status" style="font-size:12px; color: var(--muted); margin-top:8px;"></div>
      </div>
    </section>

    <section class="tab" id="tab-comms">
      <h3 class="section-title" style="margin-top:0;">Parent-Teacher Communication</h3>
       <div id="comms-alert" class="error" style="display:none; background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); color: #bbf7d0;">
         New messages received. Open Communications to view.
       </div>
      <div id="comm-error" class="error"></div>
      <form id="comm-form">
        <div class="flex" style="flex-wrap: wrap; gap:16px; grid-column: span 2;">
          <div style="flex:1; min-width:200px;">
            <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Student Reference</label>
            <input id="comm-student-search" class="pill-input" placeholder="Search student name..." autocomplete="off" />
            <div id="comm-student-suggestions" class="suggestions"></div>
            <input type="hidden" id="comm-student-id" />
          </div>
          <div style="flex:1; min-width:200px;">
            <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Recipient</label>
            <input id="comm-teacher-search" class="pill-input" placeholder="Search teacher..." autocomplete="off" />
            <div id="comm-teacher-suggestions" class="suggestions"></div>
            <input type="hidden" id="comm-teacher-name" />
          </div>
        </div>
        
        <input id="comm-sender" placeholder="Your name" readonly style="background: rgba(255,255,255,0.02); color: var(--muted);" />
        <input id="comm-subject" placeholder="Subject" required />
        <textarea id="comm-body" placeholder="Type your message here..." required style="grid-column: 1 / -1;"></textarea>
        <button type="submit" style="grid-column: 1 / -1;">Send / Log Message</button>
      </form>
      <p class="section-title">Message History</p>
      <table id="comm-table">
        <thead><tr><th>Subject</th><th>From</th><th>To</th><th>Student</th><th>Date</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab" id="tab-subjects">
      <h3 class="section-title" style="margin-top:0;">Subject Management</h3>
      <div class="card">
        <div id="subject-error" class="error"></div>
        <form id="subject-form" style="background: transparent; border: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
          <input id="sub-id" type="hidden" />
          <input id="sub-name" placeholder="Subject name" required />
          <select id="sub-level" required>
            <option value="">Level band</option>
            <option value="JHS">JHS (7-10)</option>
            <option value="SHS">SHS (11-12)</option>
          </select>
          <select id="sub-category" required>
            <option value="">Category</option>
            <option>Core</option>
            <option>Applied</option>
            <option>Specialized</option>
            <option>Institutional</option>
          </select>
          <select id="sub-track">
            <option value="">Track / Strand (optional)</option>
            <option>STEM</option>
            <option>ABM</option>
            <option>HUMSS</option>
            <option>ICT</option>
            <option>GAS</option>
            <option>Institutional</option>
          </select>
          <input id="sub-grade-min" type="number" min="7" max="12" placeholder="Grade from" />
          <input id="sub-grade-max" type="number" min="7" max="12" placeholder="Grade to" />
          <div style="display:flex; gap:8px; grid-column: 1 / -1; flex-wrap: wrap;">
            <button id="sub-submit" type="submit">Add Subject</button>
            <button id="sub-cancel" type="button" style="background: rgba(255,255,255,0.08); display:none;">Cancel Edit</button>
          </div>
        </form>
        <div style="max-height: 320px; overflow-y: auto; margin-top: 12px;">
          <table id="subjects-table">
            <thead><tr><th>Name</th><th>Level</th><th>Cat.</th><th>Track</th><th>Grades</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="tab" id="tab-admin">
      <h3 class="section-title" style="margin-top:0;">Adviser Dashboard</h3>
      <div class="cards">
        <div class="card"><h3>Total Students</h3><div class="value" id="admin-total-students">-</div></div>
        <div class="card"><h3>Total Grades</h3><div class="value" id="admin-total-grades">-</div></div>
        <div class="card"><h3>Attendance Logs</h3><div class="value" id="admin-total-att">-</div></div>
        <div class="card"><h3>Comms Logged</h3><div class="value" id="admin-total-comms">-</div></div>
      </div>
      
      <div class="grid">
        <div class="card">
            <h3>User Management</h3>
            <div id="user-error" class="error"></div>
            <form id="user-form" style="background: transparent; border: none; padding: 0; margin-bottom: 20px;">
            <input id="user-username" placeholder="Username" required />
            <input id="user-fullname" placeholder="Full name" required />
            <select id="user-role" required>
                <option value="">Select Role</option>
                <option>Admin</option>
                <option>Teacher</option>
                <option>Parent</option>
            </select>
            <select id="user-band">
                <option value="">Department (Teacher only)</option>
                <option value="JHS">JHS</option>
                <option value="SHS">SHS</option>
            </select>
            <input id="user-password" type="password" placeholder="Password" required />
            <button type="submit" style="grid-column: 1/-1">Create User</button>
            </form>
            <div style="max-height: 300px; overflow-y: auto;">
                <table id="users-table">
                <thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <div class="card">
            <h3 style="color: var(--danger);">Academic Risk (Lowest Avg)</h3>
            <table>
                <thead><tr><th>Student</th><th>Average %</th></tr></thead>
                <tbody id="admin-low-grades"></tbody>
            </table>
            </div>
            <div class="card">
            <h3 style="color: var(--danger);">Attendance Risk</h3>
            <table>
                <thead><tr><th>Student</th><th>Present %</th><th>Logs</th></tr></thead>
                <tbody id="admin-att-risk"></tbody>
            </table>
            </div>
             <div class="card" style="background: rgba(99, 102, 241, 0.1); border-color: var(--accent);">
                <h3 style="color: var(--accent);">Suggested Focus</h3>
                <ul id="admin-focus" style="color: var(--text); padding-left: 20px; line-height: 1.6;">
                    <li>Monitor attendance outliers</li>
                    <li>Track grade trends per subject</li>
                    <li>Review communications for escalations</li>
                </ul>
            </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = window.location.origin + "/api";
    let attendanceChart, gradesChart, trendChart;
    let studentsCache = [];
    let teachersCache = [];
    let subjectsCache = [];
    let currentUser = null;
    let usersCache = [];
    let editingSubjectId = null;
    let gradeSheetRows = [];
    let gradeSheetActivities = [];
    let gradesCache = [];
    let teacherBand = null;
    let adminBandFilter = null;
    let gradeSheetSubject = null;
    let gradeSheetRowsData = {}; // {studentId: {activityId: raw}}
    let gradeSheetSubjectWeights = { ww: 0.3, pt: 0.5, qa: 0.2 };

    function classifyGradeLevel(gradeStr) {
      if (!gradeStr) return null;
      const m = String(gradeStr).match(/(\d{1,2})/);
      if (!m) return null;
      const g = Number(m[1]);
      if (g >= 7 && g <= 10) return "JHS";
      if (g >= 11 && g <= 12) return "SHS";
      return null;
    }

    function logout() {
      localStorage.removeItem("spms_user");
      window.location.href = "index.html";
    }

    function ensureUser() {
      const user = localStorage.getItem("spms_user");
      if (!user) { window.location.href = "index.html"; return null; }
      const parsed = JSON.parse(user);
      document.getElementById("user-name").textContent = parsed.full_name || parsed.username;
      currentUser = parsed;
      if (currentUser.role === "Teacher") {
        teacherBand = currentUser.teacher_band;
        if (!teacherBand || !["JHS", "SHS"].includes(teacherBand)) {
          // fallback to previous local storage only if none set on server
          const cached = localStorage.getItem("spms_teacher_band");
          if (cached && ["JHS","SHS"].includes(cached)) {
            teacherBand = cached;
          } else {
            const picked = window.prompt("Select your level (JHS or SHS):", teacherBand || "JHS");
            if (picked && ["JHS","SHS"].includes(picked.toUpperCase())) {
              teacherBand = picked.toUpperCase();
            } else {
              teacherBand = "JHS";
            }
          }
        }
        localStorage.setItem("spms_teacher_band", teacherBand);
      }
      return parsed;
    }

    function switchTab(tab) {
      document.querySelectorAll("nav button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      document.querySelectorAll(".tab").forEach(sec => {
        sec.classList.toggle("active", sec.id === `tab-${tab}`);
      });
      if (tab === "comms") {
        loadComms(true);
      }
    }

    async function fetchJSON(path, options = {}) {
      const headers = { "Content-Type": "application/json" };
      if (currentUser?.role) headers["X-User-Role"] = currentUser.role;
      if (currentUser?.role === "Teacher" && teacherBand) headers["X-Teacher-Band"] = teacherBand;
      const res = await fetch(`${API_BASE}${path}`, {
        headers: { ...headers, ...(options.headers || {}) },
        ...options,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Request failed");
      return data;
    }

    async function loadDashboard() {
      const stats = await fetchJSON("/dashboard-stats");
      const totals = stats.totals;
      document.getElementById("total-students").textContent = totals.students;
      document.getElementById("total-grades").textContent = totals.grades;
      document.getElementById("total-behaviors").textContent = totals.behaviors;
      document.getElementById("total-comms").textContent = totals.communications;
      document.getElementById("admin-total-students").textContent = totals.students;
      document.getElementById("admin-total-grades").textContent = totals.grades;
      document.getElementById("admin-total-att").textContent = stats.attendance.Present + stats.attendance.Absent + stats.attendance.Tardy;
      document.getElementById("admin-total-comms").textContent = totals.communications;
      renderAttendance(stats.attendance);
      renderGrades(stats.average_grades);
    }

    async function loadStudents() {
      const students = await fetchJSON("/students");
      const bandFilter = (currentUser?.role === "Teacher") ? teacherBand : adminBandFilter;
      studentsCache = bandFilter
        ? students.filter(s => classifyGradeLevel(s.grade_level) === bandFilter)
        : students;
      const tbody = document.querySelector("#students-table tbody");
      const selectGrade = document.getElementById("grade-student");
      const selectAtt = document.getElementById("attendance-student");
      const selectTrend = document.getElementById("trend-student");
      const selectReport = document.getElementById("report-student");
      [selectGrade, selectAtt, selectTrend].forEach(sel => sel.innerHTML = "");
      if (selectReport) selectReport.innerHTML = "";
      const defaultOption = (text) => { const o = document.createElement("option"); o.value = ""; o.textContent = text; o.disabled = true; o.selected = true; return o; };
      selectGrade.appendChild(defaultOption("Select student"));
      selectAtt.appendChild(defaultOption("Select student"));
      selectTrend.appendChild(defaultOption("Select student"));
      if (selectReport) selectReport.appendChild(defaultOption("Select student"));
      tbody.innerHTML = "";
      students.forEach((s) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.student_number || "-"}</td>
                        <td>${s.first_name} ${s.middle_name ? s.middle_name + ". " : ""}${s.last_name}</td>
                        <td>${s.grade_level || "-"}</td>
                        <td>${s.homeroom_teacher || "-"}</td>
                        <td>${s.date_of_birth ? `DOB: ${s.date_of_birth}` : "-"}</td>
                        <td><button data-id="${s.id}" class="delete-student" style="padding:6px 10px;">Delete</button></td>`;
        tbody.appendChild(tr);
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.first_name} ${s.last_name}${s.grade_level ? " (G" + s.grade_level + ")" : ""}`;
        [selectGrade, selectAtt, selectTrend].forEach(sel => sel.appendChild(opt.cloneNode(true)));
        if (selectReport) selectReport.appendChild(opt.cloneNode(true));
      });
      // wire delete buttons
      document.querySelectorAll(".delete-student").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this student (and related records)?")) return;
          try {
            await fetchJSON(`/students/${btn.dataset.id}`, { method: "DELETE" });
            await refreshAll();
          } catch (ex) {
            alert(ex.message || "Failed to delete student.");
          }
        };
      });
    }

    async function loadSubjects() {
      const subjects = await fetchJSON("/subjects");
      const bandFilter = (currentUser?.role === "Teacher") ? teacherBand : adminBandFilter;
      subjectsCache = bandFilter
        ? subjects.filter(s => s.level_band === bandFilter)
        : subjects;
      const tbody = document.querySelector("#subjects-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      subjects.forEach(sub => {
        const tr = document.createElement("tr");
        const gradeLabel = sub.grade_min && sub.grade_max
          ? `${sub.grade_min}-${sub.grade_max}`
          : (sub.grade_min || sub.grade_max || "-");
        tr.innerHTML = `<td>${sub.name}</td>
                        <td>${sub.level_band}</td>
                        <td>${sub.category}</td>
                        <td>${sub.track || "-"}</td>
                        <td>${gradeLabel}</td>
                        <td style="display:flex; gap:8px;">
                          <button class="edit-subject" data-id="${sub.id}" style="padding:6px 10px; background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3);">Edit</button>
                          <button class="delete-subject" data-id="${sub.id}" style="padding:6px 10px;">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll(".edit-subject").forEach(btn => {
        btn.onclick = () => {
          const sub = subjectsCache.find(s => s.id === Number(btn.dataset.id));
          if (!sub) return;
          editingSubjectId = sub.id;
          document.getElementById("sub-id").value = sub.id;
          document.getElementById("sub-name").value = sub.name;
          document.getElementById("sub-level").value = sub.level_band;
          document.getElementById("sub-category").value = sub.category;
          document.getElementById("sub-track").value = sub.track || "";
          document.getElementById("sub-grade-min").value = sub.grade_min ?? "";
          document.getElementById("sub-grade-max").value = sub.grade_max ?? "";
          document.getElementById("sub-submit").textContent = "Update Subject";
          document.getElementById("sub-cancel").style.display = "inline-block";
          document.getElementById("subject-error").textContent = "";
        };
      });
      document.querySelectorAll(".delete-subject").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this subject?")) return;
          try {
            await fetchJSON(`/subjects/${btn.dataset.id}`, { method: "DELETE" });
            await loadSubjects();
            populateGradeSubjects();
          } catch (ex) {
            alert(ex.message || "Failed to delete subject.");
          }
        };
      });

      // populate grade sheet subject dropdown
      const sheetSelect = document.getElementById("sheet-subject");
      if (sheetSelect) {
        sheetSelect.innerHTML = "";
        const mkOpt = (val, text, disabled = false, selected = false) => {
          const o = document.createElement("option");
          o.value = val;
          o.textContent = text;
          o.disabled = disabled;
          if (selected) o.selected = true;
          return o;
        };
        sheetSelect.appendChild(mkOpt("", "Select subject", true, true));
        subjects.forEach(sub => {
          sheetSelect.appendChild(mkOpt(sub.name, `${sub.name} (${sub.level_band}${sub.category ? " • " + sub.category : ""}${sub.track ? " • " + sub.track : ""})`));
        });
      }

      // populate grades tab subject filter
      const gradeSubSel = document.getElementById("grade-subject");
      if (gradeSubSel) {
        const current = gradeSubSel.value;
        gradeSubSel.innerHTML = "";
        const mkOpt2 = (val, text, selected = false) => {
          const o = document.createElement("option");
          o.value = val;
          o.textContent = text;
          if (selected) o.selected = true;
          return o;
        };
        gradeSubSel.appendChild(mkOpt2("", "All subjects", !current));
        subjects.forEach(sub => {
          gradeSubSel.appendChild(mkOpt2(sub.name, sub.name, current === sub.name));
        });
      }
    }

    function populateGradeSubjects() {
      const select = document.getElementById("grade-subject");
      if (!select) return;
      const studentId = Number(document.getElementById("grade-student").value);
      const student = studentsCache.find(s => s.id === studentId);
      const band = classifyGradeLevel(student?.grade_level);
      select.innerHTML = "";
      const mkOpt = (val, text, disabled = false, selected = false) => {
        const o = document.createElement("option");
        o.value = val;
        o.textContent = text;
        o.disabled = disabled;
        if (selected) o.selected = true;
        return o;
      };
      if (!band) {
        select.appendChild(mkOpt("", "Select a student to filter subjects", true, true));
        return;
      }
      select.appendChild(mkOpt("", `Select ${band} subject`, true, true));
      const filtered = subjectsCache.filter(s => s.level_band === band);
      if (filtered.length === 0) {
        select.appendChild(mkOpt("", `No ${band} subjects available`, true, true));
        return;
      }
      filtered.forEach(sub => {
        select.appendChild(mkOpt(sub.name, `${sub.name} (${sub.category}${sub.track ? " • " + sub.track : ""})`));
      });
      computeGradeTotal();
    }

    function getWeightsForSubject(subjectName, subjectMeta, band) {
      if (!band) return null;
      const name = (subjectName || "").toLowerCase();
      const track = (subjectMeta?.track || "").toLowerCase();
      // JHS rules
      if (band === "JHS") {
        const groupA = ["english","filipino","araling panlipunan","social studies","esp","edukasyon sa pagpapakatao"];
        const groupB = ["science","math","mathematics"];
        const groupC = ["mapeh","music","arts","physical education","pe","health","tle","technology & livelihood education","computer","ict","livelihood"];
        if (groupA.some(x => name.includes(x))) return { ww:30, pt:50, qa:20 };
        if (groupB.some(x => name.includes(x))) return { ww:40, pt:40, qa:20 };
        if (groupC.some(x => name.includes(x))) return { ww:20, pt:60, qa:20 };
        return { ww:30, pt:50, qa:20 }; // default JHS
      }
      // SHS rules
      if (band === "SHS") {
        const isCore = subjectMeta?.category === "Core";
        const isWorkImmersion = name.includes("work immersion") || name.includes("research") || name.includes("capstone");
        const acadTracks = ["stem","abm","humss","gas"];
        const isAcad = acadTracks.includes(track);
        const tvlTracks = ["ict","tvl","sports","arts","design","institutional"];
        const isTvl = tvlTracks.includes(track);
        if (isCore) return { ww:25, pt:50, qa:25 };
        if (isAcad) {
          if (isWorkImmersion) return { ww:35, pt:40, qa:25 };
          return { ww:25, pt:45, qa:30 };
        }
        if (isTvl) {
          return { ww:20, pt:60, qa:20 };
        }
        // fallback SHS
        return { ww:25, pt:50, qa:25 };
      }
      return null;
    }

    function computeGradeTotal() {
      const studentSel = document.getElementById("grade-student");
      const subjectSel = document.getElementById("grade-subject");
      const wwEl = document.getElementById("grade-ww");
      const ptEl = document.getElementById("grade-pt");
      const qaEl = document.getElementById("grade-qa");
      const weightLabel = document.getElementById("grade-weights");
      const valueEl = document.getElementById("grade-value");
      // If the old single-entry controls are not present, safely exit.
      if (!studentSel || !subjectSel || !wwEl || !ptEl || !qaEl || !weightLabel || !valueEl) return;

      const studentId = Number(studentSel.value);
      const student = studentsCache.find(s => s.id === studentId);
      const band = classifyGradeLevel(student?.grade_level);
      const subjectName = subjectSel.value;
      const subjectMeta = subjectsCache.find(s => s.name === subjectName);
      const weights = getWeightsForSubject(subjectName, subjectMeta, band);
      const ww = Number(wwEl.value) || 0;
      const pt = Number(ptEl.value) || 0;
      const qa = Number(qaEl.value) || 0;

      if (!weights) {
        weightLabel.textContent = "Weights: select a student and subject";
        valueEl.value = "";
        return;
      }
      weightLabel.textContent = `Weights: WW ${weights.ww}%, PT ${weights.pt}%, QA ${weights.qa}%`;
      const total = ((ww * weights.ww) + (pt * weights.pt) + (qa * weights.qa)) / 100;
      valueEl.value = total ? total.toFixed(2) : "";
    }

    function downloadStudentReport() {
      const studentId = Number(document.getElementById("report-student").value);
      const student = studentsCache.find(s => s.id === studentId);
      if (!student) { alert("Select a student."); return; }
      const grades = gradesCache.filter(g => g.student_id === studentId);
      const rows = grades.map(g => `<tr><td>${g.subject}</td><td>${g.assessment}</td><td>${g.grade_value}</td><td>${g.recorded_on}</td></tr>`).join("");
      const html = `
        <html><head><title>Grades - ${student.first_name} ${student.last_name}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 24px; }
          h2 { margin: 0 0 8px; }
          table { border-collapse: collapse; width: 100%; margin-top: 12px; }
          th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
          th { background: #f4f4f4; }
        </style>
        </head><body>
        <h2>Student Grades</h2>
        <div><strong>Name:</strong> ${student.first_name} ${student.last_name}</div>
        <div><strong>Grade Level:</strong> ${student.grade_level || "-"}</div>
        <table>
          <thead><tr><th>Subject</th><th>Assessment</th><th>Grade</th><th>Date</th></tr></thead>
          <tbody>${rows || "<tr><td colspan='4'>No grades yet.</td></tr>"}</tbody>
        </table>
        </body></html>`;
      const win = window.open("", "_blank");
      if (!win) { alert("Popup blocked. Allow popups to download PDF/print."); return; }
      win.document.write(html);
      win.document.close();
      win.focus();
      win.print();
    }

    function addGradeSheetActivity() {
      const name = prompt("Activity name (e.g., Quiz 1):", "");
      if (!name) return;
      const max = Number(prompt("Max score:", "20"));
      if (!max || max <= 0) { alert("Max score must be > 0"); return; }
      const comp = prompt("Component (WW/PT/QA):", "WW");
      const compNorm = (comp || "").toUpperCase();
      if (!["WW","PT","QA"].includes(compNorm)) { alert("Component must be WW, PT, or QA"); return; }
      const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random();
      gradeSheetActivities.push({ id, label: name, type: compNorm, max_score: max });
      rebuildGradeSheetFromData();
    }

    function rebuildGradeSheetFromData() {
      const subjectName = gradeSheetSubject || document.getElementById("sheet-subject").value;
      const subjectMeta = subjectsCache.find(s => s.name === subjectName);
      const band = subjectMeta?.level_band;
      gradeSheetSubject = subjectName;
      const sheetError = document.getElementById("sheet-error");
      const tbody = document.querySelector("#sheet-table tbody");
      const theadRow = document.getElementById("sheet-header-row");
      const weightsLabel = document.getElementById("sheet-weights");
      tbody.innerHTML = "";
      theadRow.innerHTML = "<th>Student</th>";

      // infer weights
      const weights = subjectMeta ? {
        ww: Number(subjectMeta.weight_ww || 0),
        pt: Number(subjectMeta.weight_pt || 0),
        qa: Number(subjectMeta.weight_qa || 0),
      } : gradeSheetSubjectWeights;
      if (!weights || (weights.ww + weights.pt + weights.qa) === 0) {
        weightsLabel.textContent = "Weights: not set on subject";
      } else {
        weightsLabel.textContent = `Weights: WW ${weights.ww*100}% , PT ${weights.pt*100}% , QA ${weights.qa*100}%`;
      }

      // build activities from existing grades for this subject
      if (subjectName) {
        const existing = gradesCache.filter(g => g.subject === subjectName);
        existing.forEach(g => {
          if (!gradeSheetActivities.find(a => a.label === g.assessment)) {
            gradeSheetActivities.push({
              id: g.assessment,
              label: g.assessment,
              type: g.component || "WW",
              max_score: g.max_score || 0,
            });
          }
        });
      }

      // header columns
      gradeSheetActivities.forEach(act => {
        const th = document.createElement("th");
        th.textContent = `${act.label} (${act.type}, Max ${act.max_score || 0})`;
        theadRow.appendChild(th);
      });
      theadRow.innerHTML += "<th>Final</th>";

      // students eligible
      const bandFilter = (currentUser?.role === "Teacher") ? band : (band || null);
      const eligible = bandFilter
        ? studentsCache.filter(s => classifyGradeLevel(s.grade_level) === bandFilter)
        : studentsCache;
      if (eligible.length === 0) {
        sheetError.textContent = `No students for ${bandFilter || "this"} level.`;
        return;
      }
      sheetError.textContent = "";

      gradeSheetRows = [];
      gradeSheetRowsData = {};
      eligible.forEach(s => {
        const row = { student_id: s.id, scores: {} };
        gradeSheetRows.push(row);
        gradeSheetRowsData[s.id] = {};
        const tr = document.createElement("tr");
        let cells = `<td>${s.first_name} ${s.last_name}${s.grade_level ? " (G" + s.grade_level + ")" : ""}</td>`;
        gradeSheetActivities.forEach(act => {
          // prefill from existing grades
          const existing = gradesCache.find(g => g.student_id === s.id && g.subject === subjectName && g.assessment === act.label);
          const val = existing ? existing.raw_score : "";
          row.scores[act.id] = val;
          gradeSheetRowsData[s.id][act.id] = val;
          cells += `<td><input data-id="${s.id}" data-act="${act.id}" type="number" step="0.01" min="0" style="width:100%;" value="${val}"></td>`;
        });
        cells += `<td><input data-id="${s.id}" data-field="final" type="number" step="0.01" min="0" max="100" style="width:100%;" readonly></td>`;
        tr.innerHTML = cells;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("input[data-act]").forEach(inp => {
        inp.addEventListener("input", () => {
          const sid = Number(inp.dataset.id);
          const act = inp.dataset.act;
          const row = gradeSheetRows.find(r => r.student_id === sid);
          if (!row) return;
          row.scores[act] = inp.value;
          gradeSheetRowsData[sid][act] = inp.value;
          computeSheetFinals();
        });
      });
      computeSheetFinals();
    }

    function computeSheetFinals() {
      const subjectName = gradeSheetSubject || document.getElementById("sheet-subject").value;
      const subjectMeta = subjectsCache.find(s => s.name === subjectName);
      const weights = subjectMeta ? {
        ww: Number(subjectMeta.weight_ww || 0),
        pt: Number(subjectMeta.weight_pt || 0),
        qa: Number(subjectMeta.weight_qa || 0),
      } : gradeSheetSubjectWeights;
      gradeSheetRows.forEach(row => {
        let wwRaw = 0, wwMax = 0, ptRaw = 0, ptMax = 0, qaRaw = 0, qaMax = 0;
        gradeSheetActivities.forEach(act => {
          const v = Number(row.scores[act.id]);
          const mx = Number(act.max_score || 0);
          if (isNaN(v) || isNaN(mx)) return;
          if (act.type === "WW") { wwRaw += v; wwMax += mx; }
          if (act.type === "PT") { ptRaw += v; ptMax += mx; }
          if (act.type === "QA") { qaRaw += v; qaMax += mx; }
        });
        const pct = (raw, mx) => mx > 0 ? (raw / mx) * 100 : 0;
        const wwPct = pct(wwRaw, wwMax);
        const ptPct = pct(ptRaw, ptMax);
        const qaPct = pct(qaRaw, qaMax);
        let final = "";
        if (weights) {
          final = ((wwPct * weights.ww) + (ptPct * weights.pt) + (qaPct * weights.qa));
          final = isNaN(final) ? "" : final.toFixed(2);
        }
        row.final = final;
        const finalInput = document.querySelector(`#sheet-table input[data-id="${row.student_id}"][data-field="final"]`);
        if (finalInput) finalInput.value = final;
      });
    }

    function resetGradeSheetInputs() {
      gradeSheetRows.forEach(r => { r.scores = {}; r.final = ""; });
      document.querySelectorAll("#sheet-table tbody input").forEach(inp => {
        inp.value = "";
      });
      computeSheetFinals();
    }

    async function saveGradeSheetBulk() {
      const subjectName = document.getElementById("sheet-subject").value;
      const sheetError = document.getElementById("sheet-error");
      sheetError.textContent = "";
      if (!subjectName) { sheetError.textContent = "Select a subject."; return; }
      if (gradeSheetActivities.length === 0) { sheetError.textContent = "Add at least one activity."; return; }
      const payloads = [];
      gradeSheetRows.forEach(r => {
        gradeSheetActivities.forEach(act => {
          const val = r.scores[act.id];
          if (val !== undefined && val !== "") {
            payloads.push({
              student_id: r.student_id,
              subject: subjectName,
              assessment: act.label,
              component: act.type,
              raw_score: Number(val),
              max_score: Number(act.max_score || 0),
              recorded_on: new Date().toISOString().slice(0,10),
              recorded_by: currentUser?.id,
            });
          }
        });
      });
      if (payloads.length === 0) { sheetError.textContent = "Enter at least one score."; return; }
      try {
        await fetchJSON("/grades/bulk", { method: "POST", body: JSON.stringify(payloads) });
        document.getElementById("sheet-status").textContent = "Saved.";
        await refreshAll();
      } catch (ex) {
        sheetError.textContent = ex.message;
      }
    }

    function aggregateFinalGrades(grades) {
      const map = new Map();
      grades.forEach(g => {
        const key = `${g.student_id}__${g.subject}`;
        if (!map.has(key)) {
          map.set(key, {
            student_id: g.student_id,
            subject: g.subject,
            ww: [],
            pt: [],
            qa: [],
            manualFinal: null,
            finalRecordId: null,
          });
        }
        const entry = map.get(key);
        const comp = (g.component || "").toUpperCase();
        const assess = (g.assessment || "").toLowerCase();
        if (comp === "FINAL" || assess.includes("final grade")) {
          entry.manualFinal = Number(g.grade_value);
          entry.finalRecordId = g.id;
          return;
        }
        if (comp === "WW") entry.ww.push(Number(g.grade_value));
        if (comp === "PT") entry.pt.push(Number(g.grade_value));
        if (comp === "QA") entry.qa.push(Number(g.grade_value));
      });

      return Array.from(map.values()).map(entry => {
        const subjectMeta = subjectsCache.find(s => s.name === entry.subject);
        const band = classifyGradeLevel(
          studentsCache.find(s => s.id === entry.student_id)?.grade_level
        );
        const weights = subjectMeta
          ? {
              ww: (subjectMeta.weight_ww || 0) * 100,
              pt: (subjectMeta.weight_pt || 0) * 100,
              qa: (subjectMeta.weight_qa || 0) * 100,
            }
          : getWeightsForSubject(entry.subject, subjectMeta, band);
        const avg = arr => (arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null);
        const wwAvg = avg(entry.ww);
        const ptAvg = avg(entry.pt);
        const qaAvg = avg(entry.qa);
        let finalVal = entry.manualFinal;
        if (finalVal == null) {
          const parts = [];
          if (wwAvg != null && weights?.ww) parts.push(wwAvg * (weights.ww/100));
          if (ptAvg != null && weights?.pt) parts.push(ptAvg * (weights.pt/100));
          if (qaAvg != null && weights?.qa) parts.push(qaAvg * (weights.qa/100));
          if (parts.length > 0 && weights) {
            finalVal = parts.reduce((a,b)=>a+b,0);
          } else {
            const raw = [wwAvg, ptAvg, qaAvg].filter(v => v != null);
            finalVal = raw.length ? raw.reduce((a,b)=>a+b,0) / raw.length : null;
          }
        }
        return {
          ...entry,
          wwAvg,
          ptAvg,
          qaAvg,
          final: finalVal,
          count: entry.ww.length + entry.pt.length + entry.qa.length,
        };
      });
    }

    async function saveFinalGrade(entry) {
      const payload = {
        student_id: entry.student_id,
        subject: entry.subject,
        assessment: "Final Grade",
        component: "FINAL",
        grade_value: Number(entry.final?.toFixed(2) || 0),
        recorded_on: new Date().toISOString().slice(0,10),
        recorded_by: currentUser?.id,
      };
      if (entry.finalRecordId) {
        await fetchJSON(`/grades/${entry.finalRecordId}`, { method: "PUT", body: JSON.stringify(payload) });
      } else {
        await fetchJSON("/grades", { method: "POST", body: JSON.stringify(payload) });
      }
    }

    async function deleteFinalGrade(id) {
      if (!id) return;
      await fetchJSON(`/grades/${id}`, { method: "DELETE" });
    }

    async function loadGradesTable() {
      const grades = await fetchJSON("/grades");
      gradesCache = grades;
      const tbody = document.querySelector("#grades-table tbody");
      const statusEl = document.getElementById("grade-status");
      tbody.innerHTML = "";
      const studentFilter = Number(document.getElementById("grade-student").value) || null;
      const subjectFilter = document.getElementById("grade-subject").value || "";
      const filtered = grades.filter(g => {
        if (studentFilter && g.student_id !== studentFilter) return false;
        if (subjectFilter && g.subject !== subjectFilter) return false;
        if (currentUser?.role === "Teacher" && teacherBand) {
          const s = studentsCache.find(st => st.id === g.student_id);
          if (classifyGradeLevel(s?.grade_level) !== teacherBand) return false;
        }
        return true;
      });

      const summaries = aggregateFinalGrades(filtered);
      if (!summaries.length) {
        tbody.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:12px;'>No grade data yet.</td></tr>";
        statusEl.textContent = "";
        return;
      }
      statusEl.textContent = `Showing ${summaries.length} final grade rows`;
      summaries.slice(0, 200).forEach((entry, idx) => {
        const st = studentsCache.find(s => s.id === entry.student_id);
        const studentName = st ? `${st.first_name} ${st.last_name}` : entry.student_id;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${studentName}</td>
                        <td>${entry.subject}</td>
                        <td>${entry.wwAvg != null ? entry.wwAvg.toFixed(2) : "-"}</td>
                        <td>${entry.ptAvg != null ? entry.ptAvg.toFixed(2) : "-"}</td>
                        <td>${entry.qaAvg != null ? entry.qaAvg.toFixed(2) : "-"}</td>
                        <td>${entry.final != null ? entry.final.toFixed(2) : "-"}</td>
                        <td>${entry.count}</td>
                        <td style="display:flex; gap:6px; flex-wrap:wrap;">
                          <button class="final-save" data-idx="${idx}" style="padding:6px 10px; background: var(--accent); border:none; color:white; border-radius:8px;">${entry.finalRecordId ? "Update" : "Save"}</button>
                          <button class="final-delete" data-id="${entry.finalRecordId || ""}" ${entry.finalRecordId ? "" : "disabled"} style="padding:6px 10px; background: rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4); color:#fecdd3; border-radius:8px;">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".final-save").forEach(btn => {
        btn.addEventListener("click", async () => {
          const idx = Number(btn.dataset.idx);
          const entry = summaries[idx];
          try {
            await saveFinalGrade(entry);
            await loadGradesTable();
          } catch (ex) {
            document.getElementById("grade-error").textContent = ex.message;
          }
        });
      });
      tbody.querySelectorAll(".final-delete").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (!id) return;
          try {
            await deleteFinalGrade(id);
            await loadGradesTable();
          } catch (ex) {
            document.getElementById("grade-error").textContent = ex.message;
          }
        });
      });
    }

    async function loadAttendanceTable() {
      const records = await fetchJSON("/attendance");
      const tbody = document.querySelector("#attendance-table tbody");
      tbody.innerHTML = "";
      const byBand = (currentUser?.role === "Teacher" && teacherBand)
        ? records.filter(r => {
            const s = studentsCache.find(st => st.id === r.student_id);
            return classifyGradeLevel(s?.grade_level) === teacherBand;
          })
        : records;
      byBand.slice(0, 25).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.student_id}</td><td>${r.attendance_date}</td><td>${r.status}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderAttendance(attendance) {
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      const data = [attendance.Present || 0, attendance.Absent || 0, attendance.Tardy || 0];
      if (attendanceChart) attendanceChart.destroy();
      attendanceChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Present", "Absent", "Tardy"],
          datasets: [{ 
              data, 
              backgroundColor: ["#10b981", "#ef4444", "#f59e0b"],
              borderWidth: 0
            }],
        },
        options: {
            plugins: {
                legend: { labels: { color: '#94a3b8' } }
            }
        }
      });
    }

    function renderGrades(averages) {
      const ctx = document.getElementById("gradesChart").getContext("2d");
      const labels = averages.map(a => a.subject);
      const data = averages.map(a => a.average.toFixed(2));
      if (gradesChart) gradesChart.destroy();
      gradesChart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Average %", data, backgroundColor: "#6366f1", borderRadius: 4 }] },
        options: { 
            scales: { 
                y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            },
            plugins: { legend: { display: false } }
        },
      });
    }

    async function renderTrendChart(studentId) {
      if (!studentId) return;
      const grades = await fetchJSON(`/grades?student_id=${studentId}`);
      const sorted = grades.sort((a,b) => new Date(a.recorded_on) - new Date(b.recorded_on));
      const labels = sorted.map(g => g.recorded_on);
      const data = sorted.map(g => g.grade_value);
      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Grade %", data, borderColor: "#6366f1", backgroundColor: "rgba(99, 102, 241, 0.2)", fill: true, tension: 0.3 }] },
        options: { 
            scales: { 
                y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            },
            plugins: { legend: { display: false } }
        },
      });
    }

    function updateCommsNotifications(filtered) {
      if (!currentUser || currentUser.role !== "Teacher") {
        document.getElementById("comms-badge").style.display = "none";
        const alert = document.getElementById("comms-alert");
        if (alert) alert.style.display = "none";
        return;
      }
      const badge = document.getElementById("comms-badge");
      const alert = document.getElementById("comms-alert");
      const lastSeen = localStorage.getItem("spms_comms_seen_ts") || "1970-01-01T00:00:00Z";
      const unseen = filtered.filter(c => new Date(c.created_at) > new Date(lastSeen));
      if (unseen.length > 0) {
        badge.textContent = unseen.length;
        badge.style.display = "inline-block";
        if (alert) alert.style.display = "block";
      } else {
        badge.style.display = "none";
        if (alert) alert.style.display = "none";
      }
    }

    async function loadComms(markSeen = false) {
      const comms = await fetchJSON("/communications");
      const filtered = (currentUser && currentUser.role === "Teacher")
        ? comms.filter(c => {
            const r = (c.recipient || "").toLowerCase();
            const name = (currentUser.full_name || currentUser.username || "").toLowerCase();
            return r && r === name;
          }).sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
        : comms.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      const tbody = document.querySelector("#comm-table tbody");
      tbody.innerHTML = "";
      filtered.slice(0, 25).forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.subject}</td><td>${c.sender_name} <span style="font-size:11px; opacity:0.7;">(${c.sender_role})</span></td><td>${c.recipient || "-"}</td><td>${c.student_name || "-"}</td><td>${c.created_at}</td>`;
        tbody.appendChild(tr);
      });

      // notifications
      if (filtered.length > 0) {
        const latestTs = filtered[0].created_at;
        if (markSeen) {
          localStorage.setItem("spms_comms_seen_ts", latestTs);
        }
      }
      updateCommsNotifications(filtered);
    }

    async function loadTeachers() {
      teachersCache = await fetchJSON("/users?role=Teacher");
      const teacherList = document.getElementById("teacher-options");
      if (teacherList) {
        teacherList.innerHTML = "";
        teachersCache.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.full_name || t.username;
          teacherList.appendChild(opt);
        });
      }
    }

    function renderSuggestions(list, targetEl, onPick) {
      targetEl.innerHTML = "";
      list.slice(0, 5).forEach(item => {
        const div = document.createElement("div");
        div.style.padding = "6px 10px";
        div.style.cursor = "pointer";
        div.textContent = item.label;
        div.onclick = () => onPick(item);
        targetEl.appendChild(div);
      });
    }

    function attachSuggestField(inputEl, sugEl, lookupFn, onPick) {
      let hideTimeout;
      const hide = () => { sugEl.innerHTML = ""; };
      inputEl.addEventListener("input", () => {
        const q = inputEl.value.toLowerCase().trim();
        if (!q) { hide(); return; }
        const matches = lookupFn(q);
        renderSuggestions(matches, sugEl, (item) => {
          onPick(item);
          hide();
        });
      });
      inputEl.addEventListener("focus", () => {
        const q = inputEl.value.toLowerCase().trim();
        if (!q) { hide(); return; }
        const matches = lookupFn(q);
        renderSuggestions(matches, sugEl, (item) => {
          onPick(item);
          hide();
        });
      });
      inputEl.addEventListener("blur", () => {
        hideTimeout = setTimeout(hide, 120);
      });
      sugEl.addEventListener("mouseenter", () => clearTimeout(hideTimeout));
      sugEl.addEventListener("mouseleave", () => hideTimeout = setTimeout(hide, 80));
    }

    async function loadAdviserInsights() {
      const data = await fetchJSON("/adviser-insights");
      const low = document.getElementById("admin-low-grades");
      const att = document.getElementById("admin-att-risk");
      low.innerHTML = data.low_grades.length
        ? data.low_grades.map(l => `<tr><td>${l.student_name}</td><td>${l.average.toFixed(2)}</td></tr>`).join("")
        : "<tr><td colspan='2'>No data</td></tr>";
      att.innerHTML = data.attendance_risk.length
        ? data.attendance_risk.map(a => `<tr><td>${a.student_name}</td><td>${a.present_rate}%</td><td>${a.total_logs}</td></tr>`).join("")
        : "<tr><td colspan='3'>No data</td></tr>";
    }

    async function loadUsers() {
      usersCache = await fetchJSON("/users");
      const pendingTeachers = usersCache.filter(u => u.role === "Teacher" && !u.approved);
      const badge = document.getElementById("admin-pending-badge");
      if (badge) {
        if (pendingTeachers.length > 0) {
          badge.textContent = pendingTeachers.length;
          badge.style.display = "inline-block";
        } else {
          badge.style.display = "none";
        }
      }
      const tbody = document.querySelector("#users-table tbody");
      tbody.innerHTML = "";
      usersCache.forEach(u => {
        const tr = document.createElement("tr");
        const status = u.approved ? "Approved" : "Pending";
        tr.innerHTML = `<td>${u.username}</td><td>${u.full_name}</td><td>${u.role}</td><td>${status}</td>
                        <td style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                          <select data-id="${u.id}" class="user-role-update" style="padding: 4px 8px; height: auto;">
                            <option ${u.role==="Admin"?"selected":""}>Admin</option>
                            <option ${u.role==="Teacher"?"selected":""}>Teacher</option>
                            <option ${u.role==="Parent"?"selected":""}>Parent</option>
                          </select>
                          ${u.role==="Teacher" ? `<select data-id="${u.id}" class="user-band-update" style="padding: 4px 8px; height: auto;">
                              <option value="">Band</option>
                              <option value="JHS" ${u.teacher_band==="JHS"?"selected":""}>JHS</option>
                              <option value="SHS" ${u.teacher_band==="SHS"?"selected":""}>SHS</option>
                            </select>` : ""}
                          ${!u.approved && u.role==="Teacher" ? `<button class="user-approve" data-id="${u.id}" style="padding:6px 10px; background:rgba(16,185,129,0.15); color:#34d399; border:1px solid rgba(16,185,129,0.2);">Approve</button>` : ""}
                          <button class="user-delete" data-id="${u.id}" style="padding:6px 10px; background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.2);">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll(".user-role-update").forEach(sel => {
        sel.onchange = async () => {
          try {
            await fetchJSON(`/users/${sel.dataset.id}`, { method: "PUT", body: JSON.stringify({ role: sel.value }) });
          } catch (ex) {
            alert(ex.message);
            await loadUsers();
          }
        };
      });
      document.querySelectorAll(".user-band-update").forEach(sel => {
        sel.onchange = async () => {
          try {
            await fetchJSON(`/users/${sel.dataset.id}`, { method: "PUT", body: JSON.stringify({ teacher_band: sel.value || null }) });
            await loadUsers();
          } catch (ex) {
            alert(ex.message);
            await loadUsers();
          }
        };
      });
      document.querySelectorAll(".user-approve").forEach(btn => {
        btn.onclick = async () => {
          try {
            await fetchJSON(`/users/${btn.dataset.id}`, { method: "PUT", body: JSON.stringify({ approved: true }) });
            await loadUsers();
          } catch (ex) {
            alert(ex.message);
          }
        };
      });
      document.querySelectorAll(".user-delete").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this user?")) return;
          try {
            await fetchJSON(`/users/${btn.dataset.id}`, { method: "DELETE" });
            await loadUsers();
          } catch (ex) {
            alert(ex.message);
          }
        };
      });
    }

    function wireForms(user) {
      document.getElementById("student-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("student-error");
        err.textContent = "";
        const last5 = document.getElementById("student-number").value.trim();
        if (!/^\d{5}$/.test(last5)) { err.textContent = "Enter last 5 digits (numbers only)."; return; }
        const formattedNumber = `STU-${last5}`;
        const homeroomRaw = document.getElementById("student-homeroom").value.trim();
        const homeroomValid = teachersCache.some(t => (t.full_name || t.username) === homeroomRaw);
        if (homeroomRaw && !homeroomValid) {
          err.textContent = "Choose a homeroom teacher from the list.";
          return;
        }
        const payload = {
          student_number: formattedNumber,
          first_name: document.getElementById("student-first").value.trim(),
          middle_name: document.getElementById("student-middle").value.trim() || undefined,
          last_name: document.getElementById("student-last").value.trim(),
          date_of_birth: document.getElementById("student-dob").value || undefined,
          grade_level: document.getElementById("student-grade").value || undefined,
          homeroom_teacher: homeroomRaw || undefined,
        };
        try {
          await fetchJSON("/students", { method: "POST", body: JSON.stringify(payload) });
          e.target.reset();
          await refreshAll();
        } catch (ex) { err.textContent = ex.message; }
      });

      document.getElementById("attendance-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("attendance-error");
        err.style.color = "#fca5a5";
        err.textContent = "";
        const payload = {
          student_id: Number(document.getElementById("attendance-student").value),
          attendance_date: document.getElementById("attendance-date").value,
          status: document.getElementById("attendance-status").value,
          recorded_by: user?.id,
        };
        if (!payload.student_id) { err.textContent = "Select a student."; return; }
        if (!payload.attendance_date) { err.textContent = "Pick a date."; return; }
        if (!payload.status) { err.textContent = "Select a status."; return; }
        try {
          await fetchJSON("/attendance", { method: "POST", body: JSON.stringify(payload) });
          e.target.reset();
          err.style.color = "#34d399";
          err.textContent = "Attendance recorded.";
          await refreshAll();
        } catch (ex) { err.textContent = ex.message; }
      });

      // Communications form
      const studentSearch = document.getElementById("comm-student-search");
      const studentSug = document.getElementById("comm-student-suggestions");
      const studentIdHidden = document.getElementById("comm-student-id");
      const teacherSearch = document.getElementById("comm-teacher-search");
      const teacherSug = document.getElementById("comm-teacher-suggestions");
      const teacherNameHidden = document.getElementById("comm-teacher-name");

      attachSuggestField(
        studentSearch,
        studentSug,
        (q) => studentsCache
          .filter(s => (`${s.first_name} ${s.last_name}`).toLowerCase().includes(q))
          .map(s => ({ id: s.id, label: `${s.first_name} ${s.last_name}` })),
        (item) => {
          studentSearch.value = item.label;
          studentIdHidden.value = item.id;
        }
      );

      attachSuggestField(
        teacherSearch,
        teacherSug,
        (q) => teachersCache
          .filter(t => (t.full_name || t.username).toLowerCase().includes(q))
          .map(t => ({ id: t.id, label: t.full_name || t.username })),
        (item) => {
          teacherSearch.value = item.label;
          teacherNameHidden.value = item.label;
        }
      );

      document.getElementById("comm-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("comm-error"); err.textContent = "";
        const payload = {
          student_id: studentIdHidden.value || undefined,
          sender_name: user.full_name || user.username,
          sender_role: user.role,
          recipient: teacherNameHidden.value || teacherSearch.value.trim() || undefined,
          subject: document.getElementById("comm-subject").value.trim(),
          message_body: document.getElementById("comm-body").value.trim(),
        };
        try {
          await fetchJSON("/communications", { method: "POST", body: JSON.stringify(payload) });
          e.target.reset();
          studentIdHidden.value = "";
          teacherNameHidden.value = "";
          studentSearch.value = "";
          teacherSearch.value = "";
          await loadComms();
          await loadDashboard();
          localStorage.setItem("spms_comms_seen_ts", new Date().toISOString());
          updateCommsNotifications([]);
        } catch (ex) { err.textContent = ex.message; }
      });

      document.getElementById("user-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const err = document.getElementById("user-error"); err.textContent = "";
        const payload = {
          username: document.getElementById("user-username").value.trim(),
          full_name: document.getElementById("user-fullname").value.trim(),
          role: document.getElementById("user-role").value,
          password: document.getElementById("user-password").value.trim(),
        teacher_band: document.getElementById("user-band").value || undefined,
        };
        if (!payload.role) { err.textContent = "Select a role"; return; }
        try {
          await fetchJSON("/users", { method: "POST", body: JSON.stringify(payload) });
          e.target.reset();
          await loadUsers();
        } catch (ex) { err.textContent = ex.message; }
      });

      const subjectForm = document.getElementById("subject-form");
      if (subjectForm) {
        subjectForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const err = document.getElementById("subject-error"); err.textContent = "";
          const payload = {
            name: document.getElementById("sub-name").value.trim(),
            level_band: document.getElementById("sub-level").value,
            category: document.getElementById("sub-category").value,
            track: document.getElementById("sub-track").value || undefined,
            grade_min: document.getElementById("sub-grade-min").value ? Number(document.getElementById("sub-grade-min").value) : undefined,
            grade_max: document.getElementById("sub-grade-max").value ? Number(document.getElementById("sub-grade-max").value) : undefined,
          };
          if (!payload.level_band || !payload.category) {
            err.textContent = "Select level band and category.";
            return;
          }
          try {
            if (editingSubjectId) {
              await fetchJSON(`/subjects/${editingSubjectId}`, { method: "PUT", body: JSON.stringify(payload) });
            } else {
              await fetchJSON("/subjects", { method: "POST", body: JSON.stringify(payload) });
            }
            resetSubjectForm();
            await loadSubjects();
          } catch (ex) { err.textContent = ex.message; }
        });
        document.getElementById("sub-cancel").addEventListener("click", () => {
          resetSubjectForm();
        });
      }

      document.getElementById("trend-refresh").addEventListener("click", async () => {
        const studentId = document.getElementById("trend-student").value;
        await renderTrendChart(studentId);
      });

      const gradeStudent = document.getElementById("grade-student");
      if (gradeStudent) {
        gradeStudent.addEventListener("change", () => populateGradeSubjects());
      }
      const gradeSubjectSelect = document.getElementById("grade-subject");
      if (gradeSubjectSelect) {
        gradeSubjectSelect.addEventListener("change", () => computeGradeTotal());
      }

      const sheetSubject = document.getElementById("sheet-subject");
      if (sheetSubject) {
        sheetSubject.addEventListener("change", () => {
          gradeSheetSubject = sheetSubject.value;
          rebuildGradeSheetFromData();
        });
        document.getElementById("sheet-add-activity").addEventListener("click", () => addGradeSheetActivity());
        document.getElementById("sheet-save").addEventListener("click", () => saveGradeSheetBulk());
      }

      const reportBtn = document.getElementById("grade-report-btn");
      if (reportBtn) {
        reportBtn.addEventListener("click", () => downloadStudentReport());
      }
      const gradeRefresh = document.getElementById("grade-refresh");
      if (gradeRefresh) {
        gradeRefresh.addEventListener("click", () => loadGradesTable());
      }

      const sheetBand = document.getElementById("sheet-band");
      if (sheetBand) {
        sheetBand.addEventListener("change", async () => {
          adminBandFilter = sheetBand.value || null;
          await refreshAll();
        });
      }
    }

    async function refreshUserBand() {
      if (!currentUser || currentUser.role !== "Teacher") return;
      try {
        const data = await fetchJSON(`/users?user_id=${currentUser.id}`);
        if (Array.isArray(data) && data.length === 1) {
          const u = data[0];
          currentUser.teacher_band = u.teacher_band;
          teacherBand = u.teacher_band || teacherBand;
          if (teacherBand) localStorage.setItem("spms_teacher_band", teacherBand);
        }
      } catch (ex) {
        console.warn("Could not refresh user band", ex);
      }
    }

    async function refreshAll() {
      await refreshUserBand();
      await Promise.all([
        loadDashboard(),
        loadStudents(),
        loadSubjects(),
        loadGradesTable(),
        loadAttendanceTable(),
        loadTeachers(),
        loadComms(),
        loadAdviserInsights(),
        loadUsers(),
      ]);
      populateGradeSubjects();
      computeGradeTotal();
      buildGradeSheet();
    }

    function resetSubjectForm() {
      editingSubjectId = null;
      document.getElementById("sub-id").value = "";
      document.getElementById("sub-name").value = "";
      document.getElementById("sub-level").value = "";
      document.getElementById("sub-category").value = "";
      document.getElementById("sub-track").value = "";
      document.getElementById("sub-grade-min").value = "";
      document.getElementById("sub-grade-max").value = "";
      document.getElementById("sub-submit").textContent = "Add Subject";
      document.getElementById("sub-cancel").style.display = "none";
      const err = document.getElementById("subject-error");
      if (err) err.textContent = "";
    }

    function applyRoleVisibility(role) {
      const tabButtons = document.querySelectorAll("nav button[data-tab]");
      const hiddenTabs = [];
      // Default: Admin sees all, Teacher sees all but admin/subjects; Parent read-only.
      if (role === "Parent") {
        hiddenTabs.push("students", "logs", "admin"); // no CRUD
        hiddenTabs.push("subjects");
        hiddenTabs.push("attendance");
        // disable forms
        document.querySelectorAll("form button").forEach(b => {
          if (!b.closest("#comm-form")) b.disabled = true;
        });
      }
      if (role === "Teacher") {
        // hide admin + subjects tab
        hiddenTabs.push("admin");
        hiddenTabs.push("subjects");
      }
      const sheetBand = document.getElementById("sheet-band");
      if (sheetBand) {
        sheetBand.style.display = role === "Admin" ? "block" : "none";
        if (role !== "Admin") {
          sheetBand.value = "";
          adminBandFilter = null;
        }
      }
      tabButtons.forEach(btn => {
        const tab = btn.dataset.tab;
        if (hiddenTabs.includes(tab)) {
          btn.style.display = "none";
          if (btn.classList.contains("active")) switchTab("overview");
        }
      });
      // Also hide tab sections
      hiddenTabs.forEach(tab => {
        const section = document.getElementById(`tab-${tab}`);
        if (section) section.style.display = "none";
      });
      // For parents, make read-only tables still visible
      if (role === "Parent") {
        // allow switching only overview, trends, comms
        tabButtons.forEach(btn => {
          if (!["overview", "trends", "comms"].includes(btn.dataset.tab)) {
            btn.style.display = "none";
          }
        });
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const user = ensureUser();
      if (!user) return;

      applyRoleVisibility(user.role);

      document.querySelectorAll("nav button[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });

      wireForms(user);
      await refreshAll();

      // Poll for new comms for teachers
      if (user.role === "Teacher") {
        setInterval(() => loadComms(false), 30000);
      }
    });
  </script>
</body>
</html>